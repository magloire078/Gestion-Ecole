rules_version = '2';

service firebase.storage {
  match /b/greecole.firebasestorage.app/o {

    // =================================
    //         HELPER FUNCTIONS
    // =================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
      let userRootPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return isSignedIn() && 
             exists(userRootPath) && 
             'isSuperAdmin' in get(userRootPath).data && 
             get(userRootPath).data.isSuperAdmin == true;
    }

    function isSchoolMember(schoolId) {
      if (isSuperAdmin()) { return true; }
      
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      if (!userDoc.exists()) {
        return false;
      }
      let userData = userDoc.data;
      
      return 'schools' in userData && userData.schools != null &&
             schoolId in userData.schools;
    }
    
    function isDirector(schoolId) {
        let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
         if (!userDoc.exists()) {
            return false;
        }
        let userData = userDoc.data;
        return isSchoolMember(schoolId) && 
            'schools' in userData && userData.schools != null &&
             schoolId in userData.schools &&
             userData.schools[schoolId] == 'directeur';
    }
    
    function hasPermission(schoolId, permission) {
        if (isSuperAdmin()) { return true; }
        if (isDirector(schoolId)) { return true; }

        let staffProfile = get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid));
        if (!staffProfile.exists() || staffProfile.data.adminRole == null) { return false; }
        
        let roleDoc = get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(staffProfile.data.adminRole));
        if (!roleDoc.exists()) { return false; }
        
        let permissions = roleDoc.data.permissions;
        return permission in permissions && permissions[permission] == true;
    }
    
    // =================================
    //              RULES
    // =================================

    // By default, deny all reads and writes. More specific rules below will grant access.

    // Temporary logo uploads during school creation
    match /temp-logos/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
    
    // Main school logo
    match /ecoles/{schoolId}/logos/{allPaths=**} {
      allow read: if true;
      allow write: if hasPermission(schoolId, 'manageSettings');
    }
    
    // Student photos in their profile or during registration
    match /ecoles/{schoolId}/eleves/{studentId}/avatars/{allPaths=**} {
       allow read: if true;
       allow write: if hasPermission(schoolId, 'manageUsers');
    }

    // Temporary student photos during registration
    match /ecoles/{schoolId}/student-photos/{allPaths=**} {
        allow read: if true;
        allow write: if hasPermission(schoolId, 'manageUsers');
    }
    
    // Staff photos
    match /ecoles/{schoolId}/staff/{staffId}/avatars/{allPaths=**} {
       allow read: if true;
       allow write: if hasPermission(schoolId, 'manageUsers') || (isSignedIn() && request.auth.uid == staffId);
    }
    
    // Library book covers
    match /ecoles/{schoolId}/library_covers/{allPaths=**} {
       allow read: if true;
       allow write: if hasPermission(schoolId, 'manageLibrary');
    }

    // Inventory photos
    match /ecoles/{schoolId}/inventory-photos/{allPaths=**} {
       allow read: if true;
       allow write: if hasPermission(schoolId, 'manageInventory');
    }
  }
}

rules_version = '2';

service firebase.storage {
  match /b/greecole.firebasestorage.app/o {

    // =================================
    //         HELPER FUNCTIONS
    // =================================

    function isSignedIn() {
      return request.auth != null;
    }

    // Correctly checks if the user is associated with the school via the /users/{userId} document
    function isSchoolMember(schoolId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.schools.exists(s => s.schoolId == schoolId);
    }

    // Gets the staff profile to check for role
    function getStaffProfile(schoolId) {
      return get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data;
    }

    // Checks if the user is a director of the school
    function isDirector(schoolId) {
        return isSchoolMember(schoolId) && getStaffProfile(schoolId).role == 'directeur';
    }
    
    // =================================
    //              RULES
    // =================================

    // General read access for school members
    match /ecoles/{schoolId}/{allPaths=**} {
      allow read: if isSchoolMember(schoolId);
    }
    
    // Temporary logo uploads during school creation
    match /temp-logos/{userId}/{allPaths=**} {
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
    
    // Main school logo (school settings page)
    match /ecoles/{schoolId}/logos/{allPaths=**} {
      allow write: if isDirector(schoolId);
    }
    
    // Student photos in their profile or during registration
    match /ecoles/{schoolId}/eleves/{studentId}/avatars/{allPaths=**} {
       allow write: if isDirector(schoolId) || (isSchoolMember(schoolId) && getStaffProfile(schoolId).role in ['directeur_pedagogique', 'secretaire']);
    }

    // Temporary photos during student registration
    match /ecoles/{schoolId}/student-photos/{allPaths=**} {
        allow write: if isDirector(schoolId) || (isSchoolMember(schoolId) && getStaffProfile(schoolId).role in ['directeur_pedagogique', 'secretaire']);
    }
    
    // Staff photos
    match /ecoles/{schoolId}/staff/{staffId}/avatars/{allPaths=**} {
       allow write: if isDirector(schoolId) || (isSignedIn() && request.auth.uid == staffId);
    }
  }
}

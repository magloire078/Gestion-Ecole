// Règle de sécurité renforcée (Phase 1)
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }
    
    function isAdmin() {
      // Pour l'instant, seul l'admin a ce claim, ou l'email hardcodé.
      return request.auth.token.admin == true || request.auth.token.email == "magloire078@gmail.com";
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Fonction pour vérifier si un utilisateur appartient à une école
    function belongsToSchool(schoolId) {
        return get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid)).data.schoolId == schoolId;
    }

    // --- Global Collections ---
    
    // Les utilisateurs peuvent gérer leur propre document racine
    match /utilisateurs/{userId} {
      allow read, write: if isOwner(userId);
      allow list: if isAdmin();
    }

    // Les admins peuvent gérer les rôles
    match /admin_roles/{roleId} {
      allow read, write: if isAdmin();
      // Allow list for admins
      allow list: if isAdmin();
    }
    
    // --- School Collections ---

    // N'importe quel utilisateur authentifié peut créer une école.
    // Seuls les membres de l'école peuvent la mettre à jour.
    match /ecoles/{schoolId} {
       allow get: if isAuth();
       allow list: if isAuth(); // Autorise la recherche d'école par code
       allow create: if isAuth(); // Permet la création initiale de l'école
       allow update: if belongsToSchool(schoolId) || isAdmin();
       allow delete: if isAdmin(); // Seuls les admins peuvent supprimer une école
    }
    
    // Une fois l'école créée, seuls ses membres (ou un admin) peuvent lire/écrire dans les sous-collections.
    // La création est autorisée pour tout utilisateur authentifié pour permettre l'onboarding.
    match /ecoles/{schoolId}/{document=**} {
      allow create: if isAuth();
      allow read, update, delete: if belongsToSchool(schoolId) || isAdmin();
    }
  }
}

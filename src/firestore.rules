
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth.token.admin == true;
    }

    function getUserSchoolId() {
      let userDoc = get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid));
      return userDoc.exists ? userDoc.data.schoolId : null;
    }
    
    function isUserInSchool(schoolId) {
      return isAuth() && getUserSchoolId() == schoolId;
    }
    
    function isSchoolDirector(schoolId) {
      // This rule needs the school document to be passed in resource variable
      // or to be read directly. For updates, it's in resource.data.
      let schoolDoc = get(/databases/$(database)/documents/ecoles/$(schoolId));
      return schoolDoc.exists && schoolDoc.data.directorId == request.auth.uid;
    }

    // --- Special function for school creation ---
    function isSchoolCreation() {
      return isAuth() &&
             request.resource.data.directorId == request.auth.uid &&
             !exists(/databases/$(database)/documents/utilisateurs/$(request.auth.uid));
    }
    
    // === ROOT COLLECTIONS ===
    
    match /admin_roles/{roleId} {
      allow read, write: if isAdmin();
    }

    match /utilisateurs/{userId} {
      allow create: if isAuth() && userId == request.auth.uid;
      allow read, update: if isAuth() && userId == request.auth.uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /ecoles/{schoolId} {
      allow create: if isSchoolCreation() || isAdmin();
      allow read: if isUserInSchool(schoolId) || isAdmin();
      allow update: if isSchoolDirector(schoolId) || isAdmin();
      allow delete: if isAdmin();
      
        // --- SUB-COLLECTIONS ---
      
        // Allow a director to create their own staff profile during school creation
        match /personnel/{staffId} {
            allow create: if (isSchoolCreation() && staffId == request.auth.uid && request.resource.data.role == 'directeur') || (isUserInSchool(schoolId) && isSchoolDirector(schoolId)) || isAdmin();
            allow read: if isUserInSchool(schoolId) || (isAuth() && staffId == request.auth.uid);
            allow update: if (isUserInSchool(schoolId) && isSchoolDirector(schoolId)) || (isAuth() && staffId == request.auth.uid) || isAdmin();
            allow delete: if (isUserInSchool(schoolId) && isSchoolDirector(schoolId)) || isAdmin();
        }

        match /classes/{classId} {
            allow read, list: if isUserInSchool(schoolId);
            allow create, update, delete: if isSchoolDirector(schoolId) || isAdmin();
        }

        match /eleves/{studentId} {
            allow read, list: if isUserInSchool(schoolId);
            allow create, update, delete: if isSchoolDirector(schoolId) || isAdmin();

            match /notes/{gradeId} {
                allow read, write: if isUserInSchool(schoolId);
            }
            match /paiements/{paymentId} {
                allow read, write: if isUserInSchool(schoolId);
            }
        }
        
        match /cycles/{cycleId} {
             allow create: if isSchoolCreation() || isAdmin();
             allow read, list: if isUserInSchool(schoolId);
             allow update, delete: if isSchoolDirector(schoolId) || isAdmin();
        }

        // Default rule for other subcollections
        match /{subCollection}/{docId} {
            allow read, list: if isUserInSchool(schoolId);
            allow create, update, delete: if isSchoolDirector(schoolId) || isAdmin();
        }
    }

    // Catch-all to deny everything else
    match /{path=**} {
      allow read, write: if false;
    }
  }
}

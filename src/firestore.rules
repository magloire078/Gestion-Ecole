rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================
    //         HELPER FUNCTIONS
    // =================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isSchoolMember(schoolId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      if (!userDoc.exists()) {
        return false;
      }
      let userData = userDoc.data;
      
      // Super Admins are implicitly members of all schools
      if (userData.isSuperAdmin == true) {
        return true;
      }
      
      return isSignedIn() &&
             'schools' in userData && userData.schools != null &&
             schoolId in userData.schools;
    }
    
    function isDirector(schoolId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      if (!userDoc.exists()) {
        return false;
      }
      let userData = userDoc.data;
      return isSchoolMember(schoolId) && 
             'schools' in userData && userData.schools != null &&
             schoolId in userData.schools &&
             userData.schools[schoolId] == 'directeur';
    }
    
    function isSuperAdmin() {
      let userRootPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return isSignedIn() && 
             exists(userRootPath) && 
             'isSuperAdmin' in get(userRootPath).data && 
             get(userRootPath).data.isSuperAdmin == true;
    }

    function hasPermission(schoolId, permission) {
      if (isSuperAdmin()) { return true; }
      if (isDirector(schoolId)) { return true; }

      let staffProfile = get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid));
      if (!staffProfile.exists() || staffProfile.data.adminRole == null) { return false; }
      
      let roleDoc = get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(staffProfile.data.adminRole));
      if (!roleDoc.exists()) { return false; }
      
      let permissions = roleDoc.data.permissions;
      return permission in permissions && permissions[permission] == true;
    }

    function canListPayroll(schoolId) {
      if (isDirector(schoolId)) { return true; }

      let staffProfile = get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid));
      if (!staffProfile.exists() || staffProfile.data.adminRole == null) { return false; }

      let roleDoc = get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(staffProfile.data.adminRole));
      if (!roleDoc.exists()) { return false; }
      
      let permissions = roleDoc.data.permissions;
      return (permissions.manageBilling == true || permissions.manageUsers == true);
    }

    function isParentOfStudent(studentDoc) {
      return isSignedIn() &&
             'parentIds' in studentDoc.data && studentDoc.data.parentIds != null &&
             request.auth.uid in studentDoc.data.parentIds;
    }
    
    // =================================
    //         PUBLIC COLLECTIONS
    // =================================

    match /contact_requests/{requestId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }

    match /survey_responses/{responseId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }
    
    match /sessions_parents/{sessionId} {
      allow create: if true; 
      allow read: if true;
      allow update, delete: if isSuperAdmin();
    }

    // =================================
    //     ADMIN-ONLY COLLECTIONS
    // =================================
    
    match /system_logs/{logId} {
      allow read, write: if isSuperAdmin();
    }
    
    match /system_settings/{settingId} {
      allow read: if isSignedIn(); 
      allow write: if isSuperAdmin();
    }
    
    match /support_tickets/{ticketId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || hasPermission(resource.data.schoolId, 'viewSupportTickets') || hasPermission(resource.data.schoolId, 'manageSupportTickets'));
      allow update: if hasPermission(resource.data.schoolId, 'manageSupportTickets');
      allow delete: if isSuperAdmin();
    }

    // =================================
    //         USER DATA
    // =================================
    
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if isSignedIn();
      allow delete: if isSuperAdmin();
    }

    // =================================
    //         SCHOOL DATA
    // =================================
    
    match /ecoles/{schoolId} {
      allow read: if isSchoolMember(schoolId) || isSuperAdmin();
      allow create: if isSignedIn() && request.resource.data.directorId == request.auth.uid;
      allow update: if hasPermission(schoolId, 'manageSettings') || isSuperAdmin();
      allow delete: if isSuperAdmin();
    
        // --- Sub-collections of /ecoles/{schoolId} ---

        match /personnel/{staffId} {
          allow create: if (isSignedIn() && request.auth.uid == staffId && !exists(/databases/$(database)/documents/ecoles/$(schoolId))) || isDirector(schoolId);
          allow read: if isSchoolMember(schoolId);
          allow update: if (isDirector(schoolId)) || (request.auth.uid == staffId && request.resource.data.role == resource.data.role);
          allow delete: if isDirector(schoolId);
        }
        
        match /parents/{parentId} {
          allow read: if isSchoolMember(schoolId) || request.auth.uid == parentId;
          allow write: if isSchoolMember(schoolId) && hasPermission(schoolId, 'manageUsers');
        }
        
        match /admin_roles/{roleId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageSettings');
        }

        // --- Élèves et leurs sous-collections ---
        
        match /eleves/{studentId} {
          allow read: if isSchoolMember(schoolId) || isParentOfStudent(resource);
          allow write: if hasPermission(schoolId, 'manageUsers');
        }
        
        // Sous-collection Notes
        match /eleves/{studentId}/notes/{gradeId} {
          allow get: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow create, update, delete: if hasPermission(schoolId, 'manageGrades');
        }
        
        match /eleves/{studentId}/notes {
          allow list: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
        }
        
        // Sous-collection Paiements
        match /eleves/{studentId}/paiements/{paymentId} {
          allow get: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow create, update, delete: if hasPermission(schoolId, 'manageBilling');
        }
        
        match /ecoles/{schoolId}/eleves/{studentId}/paiements {
          allow list: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
        }
        
        // Sous-collection Absences
        match /eleves/{studentId}/absences/{absenceId} {
          allow get: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow create, update, delete: if hasPermission(schoolId, 'manageAttendance');
        }
        
        match /eleves/{studentId}/absences {
          allow list: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
        }
        
        // Sous-collection Incidents disciplinaires
        match /eleves/{studentId}/incidents_disciplinaires/{incidentId} {
          allow get: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow create, update, delete: if hasPermission(schoolId, 'manageDiscipline');
        }
        
        match /eleves/{studentId}/incidents_disciplinaires {
          allow list: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
        }
        
        // Dossier médical
        match /eleves/{studentId}/dossier_medical/{dossierId} {
          allow read: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow write: if hasPermission(schoolId, 'manageMedical');
        }
        
        match /eleves/{schoolId}/eleves/{studentId}/dossier_medical/{dossierId}/{subcollection}/{docId} {
          allow read: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || 
                        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow write: if hasPermission(schoolId, 'manageMedical');
        }
        
        // Collections globales (pas spécifiques à un élève)
        
        match /cycles/{cycleId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageClasses');
        }
        
        match /niveaux/{niveauId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageClasses');
        }
        
        match /classes/{classId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageClasses');
        }
        
        match /emploi_du_temps/{entryId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageSchedule');
        }
        
        match /frais_scolarite/{feeId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageBilling');
        }
        
        // Absences globales (pour les enseignants/admins)
        match /absences/{absenceId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageAttendance');
        }
        
        // Incidents disciplinaires globaux
        match /incidents_disciplinaires/{incidentId} {
          allow read, write: if hasPermission(schoolId, 'manageDiscipline');
        }
        
        match /comptabilite/{transactionId} {
          allow get: if isSchoolMember(schoolId);
          allow list: if isSchoolMember(schoolId) && 
                       (hasPermission(schoolId, 'manageBilling') || 
                        isDirector(schoolId) ||
                        isSuperAdmin());
          allow write: if hasPermission(schoolId, 'manageBilling');
        }
        
        match /bibliotheque/{bookId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageLibrary');
        }

        match /bibliotheque_prets/{loanId} {
          allow read, write: if hasPermission(schoolId, 'manageLibrary');
        }

        match /messagerie/{messageId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageCommunication');
        }
        
        match /notifications/{notificationId} {
          allow get: if isSchoolMember(schoolId) && 
                       (resource.data.userId == request.auth.uid ||
                        hasPermission(schoolId, 'manageCommunication') ||
                        hasPermission(schoolId, 'viewUsers') ||
                        isDirector(schoolId));
          
          allow list: if isSchoolMember(schoolId);
          
          allow create: if hasPermission(schoolId, 'manageCommunication') || 
                           hasPermission(schoolId, 'manageSystem') ||
                           isDirector(schoolId);
          
          allow delete: if (isSchoolMember(schoolId) && resource.data.userId == request.auth.uid) || 
                           hasPermission(schoolId, 'manageCommunication') ||
                           isDirector(schoolId);
        }
        
        match /cantine_menus/{menuId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageCantine');
        }
        
        match /cantine_reservations/{reservationId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageCantine');
        }
        
        match /cantine_abonnements/{subscriptionId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageCantine');
        }
        
        match /transport_bus/{busId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageTransport');
        }
        
        match /transport_lignes/{routeId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageTransport');
        }
        
        match /transport_abonnements/{subscriptionId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageTransport');
        }
        
        match /internat_batiments/{buildingId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageInternat');
        }
        
        match /internat_chambres/{roomId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageInternat');
        }
        
        match /internat_occupants/{occupationId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageInternat');
        }
        
        match /internat_entrees_sorties/{logId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageInternat');
        }
        
        match /batiments/{buildingId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageRooms');
        }
        
        match /salles/{salleId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageRooms');
        }
        
        match /reservations_salles/{reservationId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageRooms');
        }

        match /inventaire/{materielId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageInventory');
        }
        
        match /maintenance/{tacheId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageInventory');
        }
        
        match /cles_trousseaux/{trousseauId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageInventory');
        }
        
        match /cles_log/{logId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageInventory');
        }
        
        match /activites/{activiteId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageActivities');
        }
        
        match /inscriptions_activites/{inscriptionId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageActivities');
        }
        
        match /competitions/{competitionId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageActivities');
        }
        
        match /participations_competitions/{participationId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageActivities');
        }
        
        match /matieres/{subjectId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageClasses');
        }
        
        match /payroll_runs/{runId} {
          allow read, write: if hasPermission(schoolId, 'manageBilling') || hasPermission(schoolId, 'manageUsers');
          
          match /payslips/{payslipId} {
            allow read, write: if hasPermission(schoolId, 'manageBilling') || hasPermission(schoolId, 'manageUsers');
          }
        }
    }
  }
}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return request.auth.token.superAdmin == true;
    }

    function isDirector(schoolId) {
        return isAuth() && get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == request.auth.uid;
    }

    function getUserRole(schoolId) {
      return get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.adminRole;
    }

    function hasPermission(schoolId, permission) {
      let roleId = getUserRole(schoolId);
      if (roleId == null) {
        return false;
      }
      return get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(roleId)).data.permissions[permission] == true;
    }

    // --- Global Collections ---
    match /utilisateurs/{userId} {
      allow read, update: if isAuth() && (request.auth.uid == userId || isSuperAdmin());
      allow create: if isAuth() && request.auth.uid == userId;
    }

    match /super_admins/{adminId} {
        allow read, write: if isSuperAdmin();
    }

    match /system_logs/{logId} {
        allow read, create: if isSuperAdmin();
        allow update, delete: if false;
    }
    
    match /system_settings/{settingId} {
        allow read, write: if isSuperAdmin();
    }

    // --- School-Specific Collections ---
    match /ecoles/{schoolId} {
      allow get: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'viewSchools'));
      allow list: if isSuperAdmin();
      allow create: if isAuth(); 
      allow update: if isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageSettings');
      allow delete: if false; // Soft delete is handled by status update

        // --- School Subcollections ---
        
        match /personnel/{staffId} {
          allow read: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'viewUsers'));
          allow write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageUsers'));
        }
        
        match /admin_roles/{roleId} {
          allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId));
        }

        match /eleves/{studentId} {
          allow read: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'viewUsers'));
          allow write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageUsers'));

          // Sub-subcollections of eleves
          match /{path=**} {
             allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageUsers'));
          }
        }

        match /cycles/{cycleId} {
           allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageClasses'));
        }
        
        match /niveaux/{niveauId} {
           allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageClasses'));
        }
        
        match /classes/{classeId} {
           allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageClasses'));
        }
        
        match /emploi_du_temps/{entryId} {
           allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageSchedule'));
        }
        
        match /frais_scolarite/{feeId} {
           allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageBilling'));
        }
        
        match /absences/{absenceId} {
           allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageAttendance'));
        }
        
        match /comptabilite/{transactionId} {
           allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageBilling'));
        }
        
        match /bibliotheque/{bookId} {
           allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageLibrary'));
        }
        
        match /messagerie/{messageId} {
           allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId) || hasPermission(schoolId, 'manageCommunication'));
        }

        // Generic fallback for all other subcollections
        match /{document=**} {
            allow read, write: if isAuth() && (isSuperAdmin() || isDirector(schoolId));
        }
    }
  }
}


rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // === HELPER FUNCTIONS ===
    function isAuth() { return request.auth != null; }
    function isAdmin() { return request.auth.token.admin == true; }
    
    function getUserSchoolId() {
      let user = get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid));
      return user.exists ? user.data.schoolId : null;
    }
    
    function getStaffSchoolId(staffId) {
      // Note: This function might need adjustment depending on the final staff collection path.
      // Assuming a root /personnel collection for this helper.
      let staff = get(/databases/$(database)/documents/personnel/$(staffId));
      return staff.exists ? staff.data.schoolId : null;
    }

    // === CRÉATION INITIALE D'ÉCOLE ===
    function isSchoolCreation() {
      return isAuth() && 
             request.resource.data.directorId == request.auth.uid &&
             !exists(/databases/$(database)/documents/utilisateurs/$(request.auth.uid));
    }
    
    // === COLLECTIONS RACINES ===
    
    // Collection pour les rôles d'admin
    match /admin_roles/{roleId} {
      allow read, write: if isAdmin();
    }
    
    // Collection pour mapper les utilisateurs à leurs écoles
    match /utilisateurs/{userId} {
      allow create: if isAuth() && userId == request.auth.uid;
      allow read, update: if userId == request.auth.uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Collection principale des écoles
    match /ecoles/{schoolId} {
      allow create: if isSchoolCreation() || isAdmin();
      allow read: if isAuth() && (getUserSchoolId() == schoolId || isAdmin());
      allow update: if isSchoolDirector(schoolId) || isAdmin();
      allow delete: if isAdmin();

      // === SOUS-COLLECTIONS PAR ÉCOLE ===
      
      function isUserInSchool() {
          return isAuth() && getUserSchoolId() == schoolId;
      }
      
      function isSchoolDirector() {
          return isAuth() && resource.data.directorId == request.auth.uid;
      }

      // Personnel de l'école
      match /personnel/{staffId} {
        allow read, list: if isUserInSchool();
        allow create, update, delete: if isSchoolDirector() || isAdmin();
      }

      // Classes de l'école
      match /classes/{classId} {
        allow read, list: if isUserInSchool();
        allow create, update, delete: if isSchoolDirector() || isAdmin();
      }

      // Élèves de l'école
      match /eleves/{studentId} {
        allow read, list: if isUserInSchool();
        allow create, update, delete: if isSchoolDirector() || isAdmin();

        // Sous-collections de l'élève
        match /notes/{gradeId} {
          allow read, write: if isUserInSchool();
        }
        match /paiements/{paymentId} {
          allow read, write: if isUserInSchool();
        }
      }
      
      // Toutes les autres sous-collections (compta, bibliothèque, etc.)
      match /{collection}/{docId} {
          allow read, list: if isUserInSchool();
          allow create, update, delete: if isSchoolDirector() || isAdmin();
      }
    }
    
    // Règle par défaut pour bloquer tout ce qui n'est pas autorisé explicitement
    match /{path=**} {
      allow read, write: if false;
    }
  }
}

    

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }
    
    function isAdmin() {
      // This claim is set via a Cloud Function for super admins.
      return request.auth.token.admin == true;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Check if the user belongs to the school they are trying to access
    function belongsToSchool(schoolId) {
        return get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid)).data.schoolId == schoolId;
    }
    
    // --- Global Collections ---
    
    // Users can read/write their own root document.
    match /utilisateurs/{userId} {
      allow read, write: if isOwner(userId);
      allow list: if isAdmin();
    }

    // Admins can manage roles.
    match /admin_roles/{roleId} {
      allow read, write: if isAdmin();
    }
    
    // --- School Collections ---

    // Any authenticated user can read general school info (e.g. for joining)
    // Write access is restricted to users associated with that school.
    match /ecoles/{schoolId} {
       allow get: if isAuth();
       allow list: if isAuth(); // Allows querying for a school by code
       allow create: if isAuth(); // For initial school creation
       allow update: if isAuth() && belongsToSchool(schoolId);
       allow delete: if isAdmin(); // Only admins can delete a whole school
    }
    
    // Default-deny for all subcollections, with specific overrides below
    match /ecoles/{schoolId}/{document=**} {
      allow read, write: if isAuth() && belongsToSchool(schoolId);
    }
  }
}

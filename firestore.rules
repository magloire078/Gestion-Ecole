rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================
    //         HELPER FUNCTIONS
    // =================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isSchoolMember(schoolId) {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      let schoolPath = /databases/$(database)/documents/ecoles/$(schoolId);
      
      let isExplicitDirector = exists(schoolPath) && get(schoolPath).data.directorId == request.auth.uid;
      
      return isSignedIn() && (
        isExplicitDirector ||
        (exists(userPath) && (
          get(userPath).data.isSuperAdmin == true ||
          (
            'schools' in get(userPath).data &&
            get(userPath).data.schools != null &&
            schoolId in get(userPath).data.schools
          )
        ))
      );
    }
    
    function isDirector(schoolId) {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      let schoolPath = /databases/$(database)/documents/ecoles/$(schoolId);
      
      let isExplicitDirector = exists(schoolPath) && get(schoolPath).data.directorId == request.auth.uid;
      let hasDirectorRole = exists(userPath) && 
                           'schools' in get(userPath).data && 
                           schoolId in get(userPath).data.schools && 
                           get(userPath).data.schools[schoolId] == 'directeur';

      return isSignedIn() && (isExplicitDirector || hasDirectorRole);
    }
    
    function isSuperAdmin() {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return isSignedIn() && 
             exists(userPath) && 
             get(userPath).data.isSuperAdmin == true;
    }

    function hasPermission(schoolId, permission) {
      let staffPath = /databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid);
      
      let hasExplicitPermission = exists(staffPath) &&
        'adminRole' in get(staffPath).data &&
        get(staffPath).data.adminRole != null &&
        exists(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(get(staffPath).data.adminRole)) &&
        permission in get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(get(staffPath).data.adminRole)).data.permissions &&
        get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(get(staffPath).data.adminRole)).data.permissions[permission] == true;

      return isSuperAdmin() || isDirector(schoolId) || hasExplicitPermission;
    }

    function isParentOfStudent(studentDoc) {
      return isSignedIn() &&
             'parentIds' in studentDoc.data &&
             studentDoc.data.parentIds != null &&
             request.auth.uid in studentDoc.data.parentIds;
    }
    
    // =================================
    //         PUBLIC COLLECTIONS
    // =================================

    match /contact_requests/{requestId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }

    match /survey_responses/{responseId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }
    
    match /sessions_parents/{sessionId} {
      allow create: if true; 
      allow read: if true;
      allow update, delete: if isSuperAdmin();
    }

    // =================================
    //     ADMIN-ONLY COLLECTIONS
    // =================================
    
    match /system_logs/{logId} {
      allow read, write: if isSuperAdmin();
    }
    
    match /system_settings/{settingId} {
      allow read: if settingId == 'default' || isSignedIn(); 
      allow write: if isSuperAdmin();
    }
    
    match /support_tickets/{ticketId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (isSuperAdmin() || resource.data.userId == request.auth.uid || hasPermission(resource.data.schoolId, 'viewSupportTickets') || hasPermission(resource.data.schoolId, 'manageSupportTickets'));
      allow update: if isSuperAdmin() || hasPermission(resource.data.schoolId, 'manageSupportTickets');
      allow delete: if isSuperAdmin();
    }

    // =================================
    //         USER DATA
    // =================================
    
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isSuperAdmin();
      allow create: if isSignedIn();
      allow delete: if isSuperAdmin();
    }

    // =================================
    //         SCHOOL DATA
    // =================================
    
    match /ecoles/{schoolId} {
      allow read: if isSchoolMember(schoolId) || (isSignedIn() && resource.data.directorId == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.directorId == request.auth.uid;
      allow update: if hasPermission(schoolId, 'manageSettings');
      allow delete: if isSuperAdmin();
    
      // --- Sub-collections of /ecoles/{schoolId} ---

      match /personnel/{staffId} {
        allow create: if hasPermission(schoolId, 'manageUsers') || (request.auth.uid == staffId);
        allow read: if isSchoolMember(schoolId);
        allow update: if hasPermission(schoolId, 'manageUsers') || request.auth.uid == staffId;
        allow delete: if hasPermission(schoolId, 'manageUsers');
      }

      match /conges_personnel/{congeId} {
        allow create: if isSignedIn() && (hasPermission(schoolId, 'manageUsers') || request.resource.data.staffId == request.auth.uid);
        allow read: if isSchoolMember(schoolId) && (hasPermission(schoolId, 'manageUsers') || resource.data.staffId == request.auth.uid);
        allow update: if hasPermission(schoolId, 'manageUsers') || (isSignedIn() && resource.data.staffId == request.auth.uid && resource.data.status == 'En attente');
        allow delete: if hasPermission(schoolId, 'manageUsers');
      }
      
      match /parents/{parentId} {
        allow read: if isSchoolMember(schoolId) || request.auth.uid == parentId;
        allow write: if hasPermission(schoolId, 'manageUsers');
      }
      
      match /admin_roles/{roleId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageSettings');
      }

      // --- Élèves et leurs sous-collections ---
      
      match /eleves/{studentId} {
        allow read: if isSchoolMember(schoolId) || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
        allow write: if hasPermission(schoolId, 'manageUsers');

        match /notes/{gradeId} {
          allow read: if hasPermission(schoolId, 'viewGrades') || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow create, update, delete: if hasPermission(schoolId, 'manageGrades');
        }
        
        // === ABSENCES (collections imbriquées sous élèves) ===
        match /absences/{absenceId} {
          allow read: if hasPermission(schoolId, 'manageAttendance') || isSchoolMember(schoolId) || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow create, update, delete: if hasPermission(schoolId, 'manageAttendance') || isSchoolMember(schoolId);
        }
        
        // === INCIDENTS DISCIPLINAIRES (collections imbriquées sous élèves) ===
        match /incidents_disciplinaires/{incidentId} {
          allow read: if hasPermission(schoolId, 'manageDiscipline') || isSchoolMember(schoolId) || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow create, update, delete: if hasPermission(schoolId, 'manageDiscipline') || isSchoolMember(schoolId);
        }
        
        match /paiements/{paymentId} {
           allow read: if hasPermission(schoolId, 'manageBilling') || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
           allow write: if hasPermission(schoolId, 'manageBilling');
        }
        
        match /dossier_medical/{dossierId} {
          allow read: if hasPermission(schoolId, 'manageMedical') || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
          allow write: if hasPermission(schoolId, 'manageMedical');
          
          match /{subcollection}/{docId} {
            allow read: if hasPermission(schoolId, 'manageMedical') || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
            allow write: if hasPermission(schoolId, 'manageMedical');
          }
        }
      }
      
      // --- Collections globales de l'école ---
      
      match /cycles/{cycleId} { allow read, write: if hasPermission(schoolId, 'manageClasses'); }
      match /niveaux/{niveauId} { allow read, write: if hasPermission(schoolId, 'manageClasses'); }
      match /classes/{classId} { allow read, write: if hasPermission(schoolId, 'manageClasses'); }
      match /matieres/{subjectId} { allow read, write: if hasPermission(schoolId, 'manageClasses'); }
      match /emploi_du_temps/{entryId} { allow read, write: if hasPermission(schoolId, 'manageSchedule'); }
      match /frais_scolarite/{feeId} { allow read, write: if hasPermission(schoolId, 'manageBilling'); }
      
      // Absences au niveau école (pour compatibilité)
      match /absences/{absenceId} {
        allow create, update, delete: if hasPermission(schoolId, 'manageAttendance');
        allow read: if hasPermission(schoolId, 'manageAttendance') || 
                     (isSignedIn() &&
                      resource.data.studentId != null &&
                      isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(resource.data.studentId))));
      }
      
      // Incidents au niveau école (pour compatibilité)
      match /incidents_disciplinaires/{incidentId} {
        allow create, update, delete: if hasPermission(schoolId, 'manageDiscipline');
         allow read: if hasPermission(schoolId, 'manageDiscipline') || 
                     (isSignedIn() &&
                      resource.data.studentId != null &&
                      isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(resource.data.studentId))));
      }
      
      match /bibliotheque/{bookId} { allow read, write: if hasPermission(schoolId, 'manageLibrary'); }
      match /bibliotheque_prets/{loanId} { allow read, write: if hasPermission(schoolId, 'manageLibrary'); }
      match /messagerie/{messageId} { allow read, write: if hasPermission(schoolId, 'manageCommunication'); }
      match /cantine_menus/{menuId} { allow read, write: if hasPermission(schoolId, 'manageCantine'); }
      match /cantine_reservations/{reservationId} { allow read, write: if hasPermission(schoolId, 'manageCantine'); }
      match /cantine_abonnements/{subscriptionId} { allow read, write: if hasPermission(schoolId, 'manageCantine'); }
      match /transport_bus/{busId} { allow read, write: if hasPermission(schoolId, 'manageTransport'); }
      match /transport_lignes/{routeId} { allow read, write: if hasPermission(schoolId, 'manageTransport'); }
      match /transport_abonnements/{subscriptionId} { allow read, write: if hasPermission(schoolId, 'manageTransport'); }
      match /internat_batiments/{buildingId} { allow read, write: if hasPermission(schoolId, 'manageInternat'); }
      match /internat_chambres/{roomId} { allow read, write: if hasPermission(schoolId, 'manageInternat'); }
      match /internat_occupants/{occupationId} { allow read, write: if hasPermission(schoolId, 'manageInternat'); }
      match /internat_entrees_sorties/{logId} { allow read, write: if hasPermission(schoolId, 'manageInternat'); }
      match /batiments/{buildingId} { allow read, write: if hasPermission(schoolId, 'manageRooms'); }
      match /salles/{salleId} { allow read, write: if hasPermission(schoolId, 'manageRooms'); }
      match /reservations_salles/{reservationId} { allow read, write: if hasPermission(schoolId, 'manageRooms'); }
      match /inventaire/{materielId} { allow read, write: if hasPermission(schoolId, 'manageInventory'); }
      match /maintenance/{tacheId} { allow read, write: if hasPermission(schoolId, 'manageInventory'); }
      match /cles_trousseaux/{trousseauId} { allow read, write: if hasPermission(schoolId, 'manageInventory'); }
      match /cles_log/{logId} { allow read, write: if hasPermission(schoolId, 'manageInventory'); }

      // --- Gestion des Stocks ---
      match /stocks/{itemId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }
      match /stock_logs/{logId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }

      match /activites/{activiteId} { allow read, write: if hasPermission(schoolId, 'manageActivities'); }
      match /inscriptions_activites/{inscriptionId} { allow read, write: if hasPermission(schoolId, 'manageActivities'); }
      match /competitions/{competitionId} { allow read, write: if hasPermission(schoolId, 'manageActivities'); }
      match /participations_competitions/{participationId} { allow read, write: if hasPermission(schoolId, 'manageActivities'); }
      match /payroll_runs/{runId} {
        allow read, write: if hasPermission(schoolId, 'manageBilling');
        match /payslips/{payslipId} {
          allow read, write: if hasPermission(schoolId, 'manageBilling');
        }
      }
      
      match /comptabilite/{transactionId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageBilling');
      }
      
      match /notifications/{notificationId} {
        allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || hasPermission(schoolId, 'manageCommunication'));
        allow create: if hasPermission(schoolId, 'manageCommunication');
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow delete: if hasPermission(schoolId, 'manageCommunication');
      }

      // --- Statistiques et Finance ---
      match /stats/{statId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageBilling');
      }
    }

    // --- Global Collections ---

    match /visitor_chats/{chatId} {
      allow create: if true;
      allow read: if true; // Public for visitors
      allow update: if true; // Public for visitors and webhook
      allow delete: if isSuperAdmin();
    }

    // =================================
    //     COLLECTION GROUP RULES
    // =================================
    
    // Necessary for dashboard recent activity and lists across all students
    
    match /{path=**}/absences/{absenceId} {
      allow read: if isSignedIn() && (
        isSchoolMember(resource.data.schoolId) || 
        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(resource.data.schoolId)/eleves/$(resource.data.studentId)))
      );
    }

    match /{path=**}/incidents_disciplinaires/{incidentId} {
      allow read: if isSignedIn() && (
        isSchoolMember(resource.data.schoolId) || 
        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(resource.data.schoolId)/eleves/$(resource.data.studentId)))
      );
    }

    match /{path=**}/notes/{noteId} {
      allow read: if isSignedIn() && (
        isSchoolMember(resource.data.schoolId) || 
        isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(resource.data.schoolId)/eleves/$(resource.data.studentId)))
      );
    }

    match /{path=**}/personnel/{staffId} {
      // Used by AdminsTable and general personnel lists
      allow read: if isSignedIn() && (isSuperAdmin() || isSchoolMember(resource.data.schoolId));
    }

    match /{path=**}/dossier_medical/{dossierId} {
      allow read: if isSignedIn() && (hasPermission(resource.data.schoolId, 'manageMedical') || isSchoolMember(resource.data.schoolId));
    }

    match /{path=**}/consultations/{consultationId} {
      allow read: if isSignedIn() && (hasPermission(resource.data.schoolId, 'manageMedical') || isSchoolMember(resource.data.schoolId));
    }

    match /{path=**}/vaccins/{vaccinId} {
      allow read: if isSignedIn() && (hasPermission(resource.data.schoolId, 'manageMedical') || isSchoolMember(resource.data.schoolId));
    }
  }
}

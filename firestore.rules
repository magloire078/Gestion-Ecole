rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================
    //         HELPER FUNCTIONS
    // =================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isUserDocPresent() {
        return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserData() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isSuperAdmin() {
      return isSignedIn() && isUserDocPresent() && getUserData().isSuperAdmin == true;
    }
    
    function isSchoolMember(schoolId) {
        return isSuperAdmin() || (
          isUserDocPresent() &&
          'schools' in getUserData() && getUserData().schools != null &&
          schoolId in getUserData().schools
        );
    }
    
    function isDirector(schoolId) {
        return isSchoolMember(schoolId) && 
            'schools' in getUserData() && getUserData().schools != null &&
            getUserData().schools[schoolId] == 'directeur';
    }

    function hasPermission(schoolId, permission) {
        return isSuperAdmin() || isDirector(schoolId) || (
          exists(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.adminRole != null &&
          exists(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.adminRole)) &&
          permission in get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.adminRole)).data.permissions &&
          get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.adminRole)).data.permissions[permission] == true
        );
    }

    function canListPayroll(schoolId) {
      return isDirector(schoolId) || (
        exists(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.adminRole != null &&
        exists(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.adminRole)) &&
        (
          get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.adminRole)).data.permissions.manageBilling == true ||
          get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.adminRole)).data.permissions.manageUsers == true
        )
      );
    }

    function isParentOfStudent(studentDoc) {
      return isSignedIn() &&
             'parentIds' in studentDoc.data && studentDoc.data.parentIds != null &&
             request.auth.uid in studentDoc.data.parentIds;
    }
    
    // =================================
    //         PUBLIC COLLECTIONS
    // =================================

    match /contact_requests/{requestId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }

    match /survey_responses/{responseId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }
    
    match /sessions_parents/{sessionId} {
      allow create: if true; 
      allow read: if true;
      allow update, delete: if isSuperAdmin();
    }

    // =================================
    //     ADMIN-ONLY COLLECTIONS
    // =================================
    
    match /system_logs/{logId} {
      allow read, write: if isSuperAdmin();
    }
     match /system_logs {
      allow list: if isSuperAdmin();
    }
    
    match /system_settings/{settingId} {
      allow read: if isSignedIn(); 
      allow write: if isSuperAdmin();
    }
    
    match /support_tickets/{ticketId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || hasPermission(resource.data.schoolId, 'viewSupportTickets') || hasPermission(resource.data.schoolId, 'manageSupportTickets'));
      allow update: if hasPermission(resource.data.schoolId, 'manageSupportTickets');
      allow delete: if isSuperAdmin();
    }
    match /support_tickets {
        allow list: if isSignedIn();
    }
    
    // =================================
    //         USER DATA
    // =================================
    
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if isSignedIn();
      allow delete: if isSuperAdmin();
    }

    // =================================
    //         SCHOOL DATA
    // =================================
    
    match /ecoles {
      allow list: if isSuperAdmin();
    }

    match /ecoles/{schoolId} {
      allow read: if isSchoolMember(schoolId) || isSuperAdmin();
      allow create: if isSignedIn() && request.resource.data.directorId == request.auth.uid;
      allow update: if hasPermission(schoolId, 'manageSettings') || isSuperAdmin();
      allow delete: if isSuperAdmin();
      
      // --- Sub-collections of /ecoles/{schoolId} ---

      match /personnel/{staffId} {
        allow create: if (isSignedIn() && request.auth.uid == staffId && !exists(/databases/$(database)/documents/ecoles/$(schoolId))) || isDirector(schoolId);
        allow read: if isSchoolMember(schoolId);
        allow update: if (isDirector(schoolId)) || (request.auth.uid == staffId && request.resource.data.role == resource.data.role);
        allow delete: if isDirector(schoolId);
      }
      match /personnel {
          allow list: if isSignedIn();
      }
      
      match /parents/{parentId} {
          allow read: if isSchoolMember(schoolId) || request.auth.uid == parentId;
          allow write: if isSchoolMember(schoolId) && hasPermission(schoolId, 'manageUsers');
      }
      
      match /admin_roles/{roleId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageSettings');
      }

      match /eleves/{studentId} {
          allow read: if isSchoolMember(schoolId) || isParentOfStudent(resource);
          allow write: if hasPermission(schoolId, 'manageUsers');
      }
      match /eleves {
          allow list: if isSignedIn();
      }
      
      match /eleves/{studentId}/dossier_medical/{dossierId} {
           allow read: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
           allow write: if hasPermission(schoolId, 'manageMedical');
       }
      
       match /eleves/{studentId}/dossier_medical/{dossierId}/{subcollection}/{docId} {
           allow read: if (isSchoolMember(schoolId) && hasPermission(schoolId, 'viewUsers')) || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId)));
           allow write: if hasPermission(schoolId, 'manageMedical');
       }
      
      match /cycles/{cycleId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageClasses');
      }
       match /cycles {
          allow list: if isSignedIn();
      }
      
      match /niveaux/{niveauId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageClasses');
      }
       match /niveaux {
          allow list: if isSignedIn();
      }
      
      match /classes/{classId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageClasses');
      }
       match /classes {
          allow list: if isSignedIn();
      }
      
      match /emploi_du_temps/{entryId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageSchedule');
      }
       match /emploi_du_temps {
          allow list: if isSignedIn();
      }
      
      match /frais_scolarite/{feeId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageBilling');
      }
      
      match /absences/{absenceId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageAttendance');
      }
       match /absences {
          allow list: if isSignedIn();
      }
      
      match /incidents_disciplinaires/{incidentId} {
        allow read, write: if hasPermission(schoolId, 'manageDiscipline');
      }
       match /incidents_disciplinaires {
        allow list: if isSignedIn();
      }
      
      match /comptabilite/{transactionId} {
          allow get: if isSchoolMember(schoolId);
          allow list: if isSignedIn();
          allow write: if hasPermission(schoolId, 'manageBilling');
      }
      
      match /bibliotheque/{bookId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageLibrary');
      }
      match /bibliotheque {
          allow list: if isSignedIn();
      }

      match /bibliotheque_prets/{loanId} {
          allow read, write: if hasPermission(schoolId, 'manageLibrary');
      }
       match /bibliotheque_prets {
          allow list: if isSignedIn();
      }

      match /messagerie/{messageId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageCommunication');
      }
      match /messagerie {
        allow list: if isSignedIn();
      }
      
      match /notifications/{notificationId} {
        allow get: if isSchoolMember(schoolId) && resource.data.userId == request.auth.uid;
        
        allow list: if request.auth != null &&
                     request.query.where.size() > 0 &&
                     request.query.where[0].field == 'userId' &&
                     request.query.where[0].op == '==' &&
                     request.query.where[0].value == request.auth.uid;
        
        allow create: if hasPermission(schoolId, 'manageCommunication') || hasPermission(schoolId, 'manageSystem');
        
        allow delete: if (isSchoolMember(schoolId) && resource.data.userId == request.auth.uid) || hasPermission(schoolId, 'manageCommunication');
      }
      
      match /cantine_menus/{menuId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageCantine');
      }
      match /cantine_reservations/{reservationId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageCantine');
      }
      match /cantine_abonnements/{subscriptionId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageCantine');
      }
      
      match /transport_bus/{busId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageTransport');
      }
      match /transport_lignes/{routeId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageTransport');
      }
      match /transport_abonnements/{subscriptionId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageTransport');
      }
      
      match /internat_batiments/{buildingId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInternat');
      }
      match /internat_chambres/{roomId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInternat');
      }
      match /internat_occupants/{occupationId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInternat');
      }
      match /internat_entrees_sorties/{logId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInternat');
      }
      
       match /batiments/{buildingId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageRooms');
      }
       match /salles/{salleId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageRooms');
      }
      match /reservations_salles/{reservationId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageRooms');
      }

      match /inventaire/{materielId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }
      match /maintenance/{tacheId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }
      match /cles_trousseaux/{trousseauId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }
      match /cles_log/{logId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }
      
      match /activites/{activiteId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageActivities');
      }
      match /inscriptions_activites/{inscriptionId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageActivities');
      }
      match /competitions/{competitionId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageActivities');
      }
       match /participations_competitions/{participationId} {
          allow read: if isSchoolMember(schoolId);
          allow write: if hasPermission(schoolId, 'manageActivities');
      }
      match /matieres/{subjectId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageClasses');
      }
      match /matieres {
        allow list: if isSignedIn();
      }
      match /payroll_runs/{runId} {
        allow read, write: if hasPermission(schoolId, 'manageBilling') || hasPermission(schoolId, 'manageUsers');
        
        match /payslips/{payslipId} {
          allow read, write: if hasPermission(schoolId, 'manageBilling') || hasPermission(schoolId, 'manageUsers');
        }
      }
      match /payroll_runs {
        allow list: if canListPayroll(schoolId);
      }
    }

    // =================================
    //      COLLECTION GROUP RULES
    // =================================
    
    match /{path=**}/notes/{gradeId} {
      allow get: if isSchoolMember(resource.data.schoolId) 
                 && hasPermission(resource.data.schoolId, 'viewUsers');
      // allow list: if hasPermission(path[1], 'viewAnalytics'); // This is invalid
      allow create, update, delete: if isSchoolMember(request.resource.data.schoolId) 
                            && hasPermission(request.resource.data.schoolId, 'manageGrades');
    }

    match /{path=**}/paiements/{paymentId} {
      allow get: if (isSchoolMember(resource.data.schoolId) && hasPermission(resource.data.schoolId, 'viewUsers')) || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(resource.data.schoolId)/eleves/$(resource.data.studentId)));
      allow write: if hasPermission(resource.data.schoolId, 'manageBilling');
    }
    
    match /{path=**}/incidents_disciplinaires/{incidentId} {
      allow read, write: if hasPermission(resource.data.schoolId, 'manageDiscipline');
    }
    
    match /{path=**}/dossier_medical/{dossierId} {
      allow list: if isSignedIn();
      allow read: if isSchoolMember(path[1]) && hasPermission(path[1], 'viewUsers');
    }
    
    match /{path=**}/consultations/{consultationId} {
      allow list: if isSignedIn();
    }
    
    match /{path=**}/vaccins/{vaccinId} {
      allow list: if isSignedIn();
    }
  }
}
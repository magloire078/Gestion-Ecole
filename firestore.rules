
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== UTILITY FUNCTIONS ==========
    function isAuth() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return request.auth.token.superAdmin == true;
    }
    
    function isSchoolMember(schoolId) {
        // Un utilisateur est membre s'il est associé à l'école via son token/claim
        // OU s'il a un profil de personnel dans cette école.
        return isAuth() && 
               (request.auth.token.schoolId == schoolId || 
                exists(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)));
    }
    
    function isUser(userId) {
        return isAuth() && request.auth.uid == userId;
    }
    
    function isDirector(schoolId) {
        let schoolData = get(/databases/$(database)/documents/ecoles/$(schoolId)).data;
        return isAuth() && request.auth.uid == schoolData.directorId;
    }

    // ========== GLOBAL RULES ==========

    // Les Super Admins ont un accès total.
    match /{path=**} {
      allow read, write: if isSuperAdmin();
    }

    // ========== PUBLIC RULES (Authenticated users) ==========
    
    // N'importe qui d'authentifié peut lire la liste des écoles pour la recherche.
    match /ecoles/{schoolId} {
        allow list, get: if isAuth();
    }

    // ========== SCHOOL-CREATION RULES ==========

    // Règle spécifique et cruciale pour la création d'une école.
    // Un utilisateur authentifié peut créer une école SI ET SEULEMENT SI
    // il se désigne lui-même comme directeur dans le document en cours de création.
    match /ecoles/{schoolId} {
      allow create: if isAuth() && request.resource.data.directorId == request.auth.uid;
    }

    // Règle pour la création du profil du directeur LORS de la création de l'école.
    // L'utilisateur peut créer son propre profil de personnel (staffId == son uid)
    // SI ET SEULEMENT SI, dans la même transaction, le document école en cours de création
    // (`getAfter`) le désigne comme directeur.
    match /ecoles/{schoolId}/personnel/{staffId} {
        allow create: if isUser(staffId) && getAfter(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == staffId;
    }
    
    // ========== USER-SPECIFIC RULES ==========
    
    // Un utilisateur peut lire/écrire son propre document racine.
    match /utilisateurs/{userId} {
      allow read, write: if isUser(userId);
    }
    
    // ========== SCHOOL-MEMBER RULES (Post-Creation) ==========
    
    // Une fois l'école créée, seuls les membres peuvent y accéder.
    
    // Le directeur peut modifier les informations de l'école. Les autres membres peuvent lire.
    match /ecoles/{schoolId} {
      allow read: if isSchoolMember(schoolId);
      allow update: if isDirector(schoolId);
      // La suppression est gérée par une fonction côté serveur (soft delete)
      allow delete: if false; 
    }

    // Les membres peuvent lire les profils du personnel de leur école.
    // Seul le directeur ou l'utilisateur lui-même peut modifier un profil.
    match /ecoles/{schoolId}/personnel/{staffId} {
        allow get, list: if isSchoolMember(schoolId);
        allow update: if isDirector(schoolId) || isUser(staffId);
        allow delete: if isDirector(schoolId); // Seul le directeur peut supprimer un membre
    }
    
    // Règle générique pour toutes les autres sous-collections.
    // Permet aux membres de l'école de lire et écrire des données dans leur propre école.
    match /ecoles/{schoolId}/{collection}/{docId=**} {
      allow read, write: if isSchoolMember(schoolId);
    }
  }
}

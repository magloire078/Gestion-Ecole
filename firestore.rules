
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== UTILITY FUNCTIONS ==========
    function isAuth() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isAuth() && request.auth.token.superAdmin == true;
    }
    
    function isUser(userId) {
        return isAuth() && request.auth.uid == userId;
    }
    
    function isDirector(schoolId) {
        // Important: Ne pas utiliser `get()` dans les règles de liste de collection.
        // Cette fonction est sûre pour les opérations sur un seul document (get, create, update, delete).
        return isAuth() && get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == request.auth.uid;
    }

    function isMemberOfSchool(schoolId) {
      // La source de vérité pour l'appartenance à l'école est le token d'authentification.
      return isAuth() && request.auth.token.schoolId == schoolId;
    }
    
    // Règle pour permettre à un utilisateur de créer sa toute première école.
    function isCreatingSchoolAsDirector(schoolId) {
        let isDirectorFieldCorrect = request.resource.data.directorId == request.auth.uid;
        // Vérifie qu'il n'a pas déjà un `schoolId` dans son profil racine.
        let isFirstSchool = !exists(/databases/$(database)/documents/utilisateurs/$(request.auth.uid));
        return isAuth() && isDirectorFieldCorrect && isFirstSchool;
    }

    // ========== GLOBAL RULES ==========
    match /system_settings/{settingId} {
        allow read: if isAuth();
        allow write: if isSuperAdmin();
    }
    match /super_admins/{adminId} {
        allow read, write: if isSuperAdmin();
    }
    match /system_logs/{logId} {
      allow create: if isAuth();
      allow read: if isSuperAdmin();
    }

    // ========== ONBOARDING & USER ROOT ==========
    // Un utilisateur peut créer son propre profil racine une seule fois.
    match /utilisateurs/{userId} {
      allow read: if isUser(userId);
      allow create: if isUser(userId) && !exists(/databases/$(database)/documents/utilisateurs/$(userId));
      allow update: if false; // Ne devrait pas être mis à jour après la création.
    }
    
    // ========== SCHOOL & SUBCOLLECTIONS RULES ==========
    match /ecoles/{schoolId} {
      // Qui peut créer une école ?
      allow create: if isCreatingSchoolAsDirector(schoolId);
      
      // Qui peut lire le document principal de l'école ?
      // Un super admin OU un membre de l'école.
      allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
      
      // Qui peut mettre à jour l'école ?
      // Un super admin OU le directeur de l'école.
      allow update: if isSuperAdmin() || isDirector(schoolId);
      
      // La suppression physique est désactivée (soft delete via le statut).
      allow delete: if false;

      // --- RÈGLE GÉNÉRIQUE POUR TOUTES LES SOUS-COLLECTIONS ---
      // Cette règle s'applique à /ecoles/{schoolId}/[n'importe quelle sous-collection]/{docId}
      match /{allPaths=**} {
        // Les membres de l'école peuvent lire et écrire dans toutes les sous-collections.
        // Cela simplifie la gestion des permissions pour les données internes de l'école.
        allow read, write: if isMemberOfSchool(schoolId);
      }
    }
  }
}


rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Fonctions d'aide
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserSchoolId() {
      // Attention: Ne pas utiliser dans les règles de 'list'
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.schoolId;
    }
    
    function isAssociatedWithSchool(schoolId) {
      // Pour les règles 'get', 'write'. Ne fonctionnera pas pour 'list'.
      return isAuthenticated() && getUserSchoolId() == schoolId;
    }
    
    function isSchoolMember(schoolId) {
      return isAuthenticated() && 
             isAssociatedWithSchool(schoolId) &&
             exists(/databases/$(database)/documents/schools/$(schoolId)/members/$(request.auth.uid));
    }
    
    function isSchoolDirector(schoolId) {
      // Pour les règles 'get', 'write'.
      return isAuthenticated() && 
             get(/databases/$(database)/documents/schools/$(schoolId)).data.directorId == request.auth.uid;
    }
    
    // Collection: users
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
    }
    
    // Collection: schools
    match /schools/{schoolId} {
      allow read: if isSchoolMember(schoolId);
      allow create: if isAuthenticated(); // Tout utilisateur peut créer une école
      allow update, delete: if isSchoolDirector(schoolId);
      
      // Sous-collection: members
      match /members/{memberId} {
        allow read: if isSchoolMember(schoolId);
        allow create: if isSchoolDirector(schoolId) || (isAuthenticated() && memberId == request.auth.uid);
        allow update, delete: if isSchoolDirector(schoolId);
      }
      
      // Autres sous-collections (étudiants, classes, etc.)
      match /{collection}/{documentId} {
        allow read: if isSchoolMember(schoolId);
        // L'écriture est contrôlée par des règles plus spécifiques ou via les rôles dans le code.
        // Pour l'instant, on se base sur le rôle de directeur.
        allow write: if isSchoolDirector(schoolId);
      }
    }
  }
}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== UTILITY FUNCTIONS ==========
    function isAuth() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isAuth() && request.auth.token.superAdmin == true;
    }
    
    function isSchoolMember(schoolId) {
        // Vérifier si l'utilisateur a le schoolId dans ses claims
        // OU s'il est le directeur de cette école (vérifié dans la BD)
        return isAuth() && (
          request.auth.token.schoolId == schoolId ||
          get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == request.auth.uid
        );
    }
    
    function isUser(userId) {
        return isAuth() && request.auth.uid == userId;
    }
    
    function isDirector(schoolId) {
        // Vérifier si l'utilisateur est le directeur selon la BD
        return isAuth() && get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == request.auth.uid;
    }
    
    function isCreatingSchoolAsDirector() {
        // Vérifier si l'utilisateur crée une école où il est le directeur
        return isAuth() && request.resource.data.directorId == request.auth.uid;
    }

    // ========== GLOBAL RULES ==========

    // Les Super Admins ont un accès total.
    match /{path=**} {
      allow read, write: if isSuperAdmin();
    }

    // ========== PUBLIC RULES (Authenticated users) ==========
    
    // N'importe qui d'authentifié peut lire la liste des écoles pour la recherche.
    match /ecoles/{schoolId} {
        allow list, get: if isAuth();
    }

    // ========== SCHOOL-CREATION RULES ==========

    // Création d'une école
    match /ecoles/{schoolId} {
      allow create: if isCreatingSchoolAsDirector();
      
      // Après création, le directeur peut immédiatement lire son école
      // même sans avoir le claim schoolId dans son token
      allow read: if isAuth() && (
        isSchoolMember(schoolId) || // Membre de l'école
        get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == request.auth.uid // Ou directeur selon BD
      );
      
      allow update: if isDirector(schoolId);
      allow delete: if false; // Soft delete seulement
    }

    // Règle pour la création du profil du directeur
    match /ecoles/{schoolId}/personnel/{staffId} {
        // Permettre la création du profil directeur pendant la création de l'école
        // OU si l'utilisateur est déjà membre de l'école
        allow create: if isAuth() && (
          (staffId == request.auth.uid && request.resource.data.role == 'directeur' && 
           get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == request.auth.uid) ||
          isSchoolMember(schoolId)
        );
        
        // Lecture et écriture
        allow get, list: if isSchoolMember(schoolId);
        allow update: if isDirector(schoolId) || isUser(staffId);
        allow delete: if isDirector(schoolId);
    }
    
    // ========== USER-SPECIFIC RULES ==========
    
    // Un utilisateur peut lire/écrire son propre document racine
    match /utilisateurs/{userId} {
      allow read: if isUser(userId);
      // Permettre l'écriture pendant l'onboarding (sans claim schoolId)
      allow write: if isAuth() && (
        isUser(userId) || // L'utilisateur lui-même
        // Pendant la création d'école, le service peut mettre à jour le document
        request.resource.data.keys().hasOnly(['schoolId']) // Seulement mettre à jour schoolId
      );
    }
    
    // ========== SYSTEM LOGS ==========
    
    match /system_logs/{logId} {
      allow create: if isAuth();
      allow read: if isAuth() && (isSuperAdmin() || request.auth.token.isDirector == true);
    }

    // ========== SCHOOL-MEMBER RULES ==========
    
    // Règle générique pour toutes les autres sous-collections
    // S'assurer que cela n'écrase pas les règles spécifiques ci-dessus
    match /ecoles/{schoolId}/{collection}/{document=**} {
      allow read, write: if isSchoolMember(schoolId);
    }
  }
}

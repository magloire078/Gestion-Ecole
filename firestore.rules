
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
      return request.auth.token.superAdmin == true;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function belongsToSchool(schoolId) {
      return request.auth.token.schoolId == schoolId;
    }
    
    function isSchoolActive(schoolId) {
      let schoolDoc = get(/databases/$(database)/documents/ecoles/$(schoolId));
      return schoolDoc.data.status != 'deleted';
    }
    
    function getStaffRole(schoolId) {
      return get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data.role;
    }

    function getPermissionFromRole(schoolId, permission) {
        let staffProfile = get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data;
        // The director has all permissions
        if (staffProfile.role == 'directeur') {
          return true;
        }
        // If no admin role, no specific permissions
        if (staffProfile.adminRole == null) {
          return false;
        }
        let roleDoc = get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(staffProfile.adminRole)).data;
        return roleDoc.permissions[permission] == true;
    }

    function hasPermission(schoolId, permission) {
      // Super admin has all access
      if (isSuperAdmin()) {
          return true;
      }
      // School must be active and user must belong to it
      if (!belongsToSchool(schoolId) || !isSchoolActive(schoolId)) {
        return false;
      }
      // Check the role for the specific permission
      return getPermissionFromRole(schoolId, permission);
    }
    
    // --- System-level collections for Super Admins ---
    match /super_admins/{adminId} {
      allow read, write: if isSuperAdmin();
    }
    match /system_logs/{logId} {
      allow read, create: if isSuperAdmin();
    }
    match /system_settings/{settingId} {
      allow read, write: if isSuperAdmin();
    }

    // --- User root document ---
    match /utilisateurs/{userId} {
      allow read, update: if isOwner(userId) || isSuperAdmin();
      allow create: if isAuth(); // Allow any authenticated user to create their own root doc
    }

    // --- School Collections ---
    match /ecoles/{schoolId} {
      allow get: if isSuperAdmin() || (belongsToSchool(schoolId) && isSchoolActive(schoolId));
      allow create: if isAuth(); // Any authenticated user can create a school
      allow update: if hasPermission(schoolId, 'manageSettings');
      allow delete: if false; // Disallow hard deletes, use soft delete via 'status' field
    }
    
    // --- School Subcollections Rules ---
    match /ecoles/{schoolId}/{subcollection}/{docId} {
      allow read, list: if isSuperAdmin() || (belongsToSchool(schoolId) && isSchoolActive(schoolId));
      allow create: if isAuth(); // Simplified rule for creation
      allow update, delete: if isSuperAdmin() || (belongsToSchool(schoolId) && isSchoolActive(schoolId));
    }
    
    // Override for specific collections needing more granular control
    match /ecoles/{schoolId}/personnel/{staffId} {
      allow read, list: if hasPermission(schoolId, 'viewUsers');
      allow create, update: if hasPermission(schoolId, 'manageUsers');
      allow delete: if hasPermission(schoolId, 'manageUsers');
    }
    
    match /ecoles/{schoolId}/eleves/{studentId} {
      allow read, list: if hasPermission(schoolId, 'viewUsers');
      allow create, update, delete: if hasPermission(schoolId, 'manageUsers');
    }

    // Sub-collections of eleves
    match /ecoles/{schoolId}/eleves/{studentId}/notes/{gradeId} {
      allow read: if hasPermission(schoolId, 'viewUsers');
      allow write: if hasPermission(schoolId, 'manageGrades');
    }

    match /ecoles/{schoolId}/eleves/{studentId}/paiements/{paymentId} {
      allow read, write: if hasPermission(schoolId, 'manageBilling');
    }
    
    match /ecoles/{schoolId}/eleves/{studentId}/dossier_medical/{dossierId}/{allChildren=**} {
      allow read, write: if hasPermission(schoolId, 'manageMedical');
    }

    match /ecoles/{schoolId}/admin_roles/{roleId} {
      allow read, list: if belongsToSchool(schoolId);
      allow create, update, delete: if hasPermission(schoolId, 'manageSettings');
    }
    
    match /ecoles/{schoolId}/classes/{classId} {
      allow read, list: if belongsToSchool(schoolId);
      allow create, update, delete: if hasPermission(schoolId, 'manageClasses');
    }
    
    match /ecoles/{schoolId}/cycles/{cycleId} {
      allow read, list: if belongsToSchool(schoolId);
      allow create, update, delete: if hasPermission(schoolId, 'manageClasses');
    }
    
    match /ecoles/{schoolId}/niveaux/{niveauId} {
      allow read, list: if belongsToSchool(schoolId);
      allow create, update, delete: if hasPermission(schoolId, 'manageClasses');
    }

    match /ecoles/{schoolId}/emploi_du_temps/{entryId} {
      allow read, list: if belongsToSchool(schoolId);
      allow create, update, delete: if hasPermission(schoolId, 'manageSchedule');
    }
    
    match /ecoles/{schoolId}/absences/{absenceId} {
      allow read, list: if belongsToSchool(schoolId);
      allow create, update, delete: if hasPermission(schoolId, 'manageAttendance');
    }
    
    match /ecoles/{schoolId}/comptabilite/{transactionId} {
      allow read, write: if hasPermission(schoolId, 'manageBilling');
    }
    
    match /ecoles/{schoolId}/frais_scolarite/{feeId} {
      allow read, list: if belongsToSchool(schoolId);
      allow create, update, delete: if hasPermission(schoolId, 'manageBilling');
    }

    match /ecoles/{schoolId}/bibliotheque/{bookId} {
      allow read, list: if belongsToSchool(schoolId);
      allow write: if hasPermission(schoolId, 'manageLibrary');
    }
    
    match /ecoles/{schoolId}/messagerie/{messageId} {
      allow read, list: if belongsToSchool(schoolId);
      allow create: if belongsToSchool(schoolId);
      allow update, delete: if hasPermission(schoolId, 'manageCommunication') || request.auth.uid == resource.data.senderId;
    }
  }
}

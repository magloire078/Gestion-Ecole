rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Fonctions d'Aide Fiables ---

    function isAuth() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      // Le claim 'superAdmin' est plus fiable et performant qu'une lecture de document.
      return request.auth.token.superAdmin == true;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Fonction qui lit le schoolId depuis le token de l'utilisateur.
    // C'est la méthode la plus performante.
    function belongsToSchool(schoolId) {
      return request.auth.token.schoolId == schoolId;
    }

    // Fonction pour vérifier si une école est active.
    function isSchoolActive(schoolId) {
      let schoolDoc = get(/databases/$(database)/documents/ecoles/$(schoolId));
      return schoolDoc.exists && schoolDoc.data.status == 'active';
    }

    // Récupère le profil du personnel de l'utilisateur actuel.
    function getStaffProfile(schoolId) {
        return get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid));
    }
    
    // Vérifie si l'utilisateur est le directeur de l'école.
    function isDirector(schoolId) {
        let staffProfile = getStaffProfile(schoolId);
        return staffProfile.exists && staffProfile.data.role == 'directeur';
    }
    
    // Récupère les permissions d'un rôle admin spécifique.
    function getRolePermissions(schoolId, roleId) {
        return get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(roleId)).data.permissions;
    }
    
    // --- Collections Globales ---
    
    match /super_admins/{adminId} {
        allow read, write: if isSuperAdmin();
    }
    
    match /system_logs/{logId} {
        allow read: if isSuperAdmin();
        // Permettre à n'importe quel utilisateur authentifié d'écrire un log peut être voulu
        // pour tracer des erreurs, mais à surveiller.
        allow create: if isAuth(); 
    }
    
    match /system_settings/{settingId} {
        allow read, write: if isSuperAdmin();
    }

    match /utilisateurs/{userId} {
      allow get: if isOwner(userId) || isSuperAdmin();
      allow create: if isAuth() && isOwner(userId) && !exists(/databases/$(database)/documents/utilisateurs/$(userId));
      allow update: if isOwner(userId);
      allow delete: if isSuperAdmin();
    }

    // --- Collections de l'École ---

    match /ecoles/{schoolId} {
      allow get: if isSuperAdmin() || (belongsToSchool(schoolId) && isSchoolActive(schoolId));
      // Seul un utilisateur authentifié peut créer une école, en se désignant lui-même comme directeur.
      allow create: if isAuth() && request.resource.data.directorId == request.auth.uid;
      // Seul le directeur de l'école (ou un super admin) peut la mettre à jour.
      allow update: if isSuperAdmin() || (belongsToSchool(schoolId) && isDirector(schoolId));
      // La suppression physique est interdite. La suppression logique (changement de statut) se fait via 'update'.
      allow delete: if false;
    }

    // --- Sous-collections de l'École ---

    match /ecoles/{schoolId}/personnel/{staffId} {
      allow read, list: if isSuperAdmin() || (belongsToSchool(schoolId) && (isDirector(schoolId) || getRolePermissions(schoolId, getStaffProfile(schoolId).data.adminRole).viewUsers == true));
      allow create, update: if isSuperAdmin() || (belongsToSchool(schoolId) && (isDirector(schoolId) || getRolePermissions(schoolId, getStaffProfile(schoolId).data.adminRole).manageUsers == true));
      allow delete: if isSuperAdmin() || (belongsToSchool(schoolId) && isDirector(schoolId));
    }
    
    match /ecoles/{schoolId}/eleves/{studentId} {
      allow read, list: if isSuperAdmin() || (belongsToSchool(schoolId) && (isDirector(schoolId) || getRolePermissions(schoolId, getStaffProfile(schoolId).data.adminRole).viewUsers == true));
      allow create, update, delete: if isSuperAdmin() || (belongsToSchool(schoolId) && (isDirector(schoolId) || getRolePermissions(schoolId, getStaffProfile(schoolId).data.adminRole).manageUsers == true));
    }

    match /ecoles/{schoolId}/eleves/{studentId}/{subcollection}/{docId} {
      allow read, write: if isSuperAdmin() || (belongsToSchool(schoolId) && (isDirector(schoolId) || getRolePermissions(schoolId, getStaffProfile(schoolId).data.adminRole).manageUsers == true));
    }

    match /ecoles/{schoolId}/admin_roles/{roleId} {
      allow read, list: if isSuperAdmin() || belongsToSchool(schoolId);
      allow create, update, delete: if isSuperAdmin() || (belongsToSchool(schoolId) && isDirector(schoolId));
    }
    
    match /ecoles/{schoolId}/classes/{classId} {
      allow read, list: if isSuperAdmin() || belongsToSchool(schoolId);
      allow create, update, delete: if isSuperAdmin() || (belongsToSchool(schoolId) && (isDirector(schoolId) || getRolePermissions(schoolId, getStaffProfile(schoolId).data.adminRole).manageClasses == true));
    }
    
    match /ecoles/{schoolId}/{path=**}/ {
        allow read, write: if isSuperAdmin() || (belongsToSchool(schoolId) && isDirector(schoolId));
    }
  }
}

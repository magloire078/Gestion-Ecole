rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== UTILITY FUNCTIONS ==========
    function isAuth() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isAuth() && request.auth.token.superAdmin == true;
    }
    
    function isUser(userId) {
        return isAuth() && request.auth.uid == userId;
    }
    
    function isMemberOfSchool(schoolId) {
      // Un utilisateur est membre si son token contient l'ID de l'école.
      return isAuth() && request.auth.token.schoolId == schoolId;
    }

    function isDirector(schoolId) {
        // Le directeur est identifié via le document de l'école.
        return isAuth() && get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == request.auth.uid;
    }
    
    function isCreatingSchoolAsDirector() {
        // Pendant la création, le directorId du NOUVEAU document école doit correspondre à l'UID de l'utilisateur.
        return isAuth() && request.resource.data.directorId == request.auth.uid;
    }
    
    function isCreatingOwnStaffProfile(schoolId, staffId) {
        // Règle cruciale pour l'onboarding : permet à un utilisateur de créer son propre profil (directeur ou autre).
        return isAuth() && 
               staffId == request.auth.uid && // L'utilisateur crée son propre document.
               request.resource.data.uid == request.auth.uid; // Le champ UID dans le document correspond.
    }
    

    // ========== GLOBAL RULES ==========
    match /system_settings/{settingId} {
        allow read: if isAuth();
        allow write: if isSuperAdmin();
    }
    
    match /super_admins/{adminId} {
        allow read, write: if isSuperAdmin();
    }
    
    match /system_logs/{logId} {
      allow create: if isAuth(); // N'importe quel utilisateur authentifié peut créer un log (l'action est contrôlée par le code).
      allow read: if isSuperAdmin() || (isAuth() && request.auth.token.isDirector == true);
    }

    // ========== ONBOARDING & USER ROOT ==========
    match /utilisateurs/{userId} {
      // Un utilisateur peut lire, créer et mettre à jour son propre document racine.
      allow read, write: if isUser(userId);
    }
    
    // ========== SCHOOL & SUBCOLLECTIONS RULES ==========
    match /ecoles/{schoolId} {
      // CRÉATION : Seul le futur directeur peut créer l'école.
      allow create: if isCreatingSchoolAsDirector();
      
      // LECTURE : Les super admins et les membres de l'école peuvent lire les infos de l'école.
      allow read: if isSuperAdmin() || isMemberOfSchool(schoolId);
      
      // MISE A JOUR : Seul le directeur ou un super admin peut modifier les infos de l'école.
      allow update: if isSuperAdmin() || isDirector(schoolId);
      
      // SUPPRESSION : La suppression physique des écoles est interdite.
      allow delete: if false;

      // --- RÈGLES SPÉCIFIQUES POUR LES SOUS-COLLECTIONS ---
      
      // Règle spécifique pour la création du profil personnel (directeur ou autre)
      match /personnel/{staffId} {
        allow create: if isCreatingOwnStaffProfile(schoolId, staffId); // Permet la création pendant l'onboarding
        allow read: if isMemberOfSchool(schoolId);
        allow update: if isDirector(schoolId) || isUser(staffId); // Le directeur ou la personne elle-même.
        allow delete: if isDirector(schoolId);
      }
      
      // Règles pour toutes les autres sous-collections
      match /admin_roles/{roleId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /eleves/{studentId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /cycles/{cycleId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /niveaux/{niveauId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /classes/{classeId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /emploi_du_temps/{entryId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /frais_scolarite/{feeId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /absences/{absenceId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /comptabilite/{transactionId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /bibliotheque/{bookId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /messagerie/{messageId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /matieres/{subjectId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /cantine_menus/{menuId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /cantine_reservations/{reservationId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /cantine_abonnements/{subscriptionId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /transport_bus/{busId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /transport_lignes/{routeId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /transport_abonnements/{subscriptionId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /internat_batiments/{buildingId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /internat_chambres/{roomId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /internat_occupants/{occupationId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /internat_entrees_sorties/{logId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /inventaire/{materielId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /cles_trousseaux/{trousseauId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /cles_log/{logId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /salles/{salleId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /reservations_salles/{reservationId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /maintenance/{tacheId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /activites/{activiteId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /inscriptions_activites/{inscriptionId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /competitions/{competitionId} { allow read, write: if isMemberOfSchool(schoolId); }
      match /participations_competitions/{participationId} { allow read, write: if isMemberOfSchool(schoolId); }

      // Règles pour les sous-collections d'élèves
      match /eleves/{studentId}/{subcollection}/{docId} {
        allow read, write: if isMemberOfSchool(schoolId);
      }
    }
  }
}


rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================================================
    // Fonctions d'aide réutilisables
    // =================================================================
    
    function isAuth() {
      return request.auth != null;
    }

    // Vérifie si l'utilisateur est associé à une école via le document racine /utilisateurs
    function isAssociatedWithSchool(userId, schoolId) {
      return exists(/databases/$(database)/documents/utilisateurs/$(userId)) &&
             get(/databases/$(database)/documents/utilisateurs/$(userId)).data.schoolId == schoolId;
    }

    // Vérifie si l'utilisateur est un membre du personnel de l'école
    function isSchoolStaff(schoolId) {
      return isAuth() && isAssociatedWithSchool(request.auth.uid, schoolId) &&
             exists(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid));
    }
    
    // Vérifie si l'utilisateur est un parent de l'école (authentifié via Firebase Auth)
    function isSchoolParent(schoolId) {
        return isAuth() && isAssociatedWithSchool(request.auth.uid, schoolId) &&
               exists(/databases/$(database)/documents/ecoles/$(schoolId)/parents/$(request.auth.uid));
    }

    // Vérifie si un token de session parent est valide
    function isParent(schoolId, studentId) {
        let token = request.auth.token;
        // The studentId check might be null if we are just checking general access
        if (studentId == null) {
            return token.schoolId == schoolId;
        }
        return token.schoolId == schoolId && studentId in token.studentIds;
    }
    

    // Vérifie si l'utilisateur est un membre de l'école (personnel ou parent authentifié)
    function isSchoolMember(schoolId) {
        return isSchoolStaff(schoolId) || isSchoolParent(schoolId);
    }
    
    // Vérifie si l'UID de l'utilisateur est dans le tableau parentIds d'un élève
    function isParentOfStudent(studentDoc) {
        return isAuth() && request.auth.uid in studentDoc.data.parentIds;
    }

    // Obtient le profil du personnel de l'utilisateur qui fait la requête
    function getMyStaffProfile(schoolId) {
        return get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(request.auth.uid)).data;
    }
    
    // Obtient le profil du personnel pour un UID donné
    function getStaffProfile(schoolId, userId) {
        return get(/databases/$(database)/documents/ecoles/$(schoolId)/personnel/$(userId)).data;
    }

    // Vérifie si l'utilisateur qui fait la requête est le directeur de l'école
    function isDirector(schoolId) {
      return isAuth() && request.auth.uid == get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId;
    }
    
    // Vérifie si l'utilisateur a une permission spécifique via son rôle admin
    function hasPermission(schoolId, permission) {
        let profile = getMyStaffProfile(schoolId);
        // Le directeur a toutes les permissions par défaut
        if (isDirector(schoolId)) {
            return true;
        }
        // Si l'utilisateur n'a pas de rôle admin, il n'a pas de permission
        if (!('adminRole' in profile) || profile.adminRole == null) {
            return false;
        }
        // Recherche la permission dans le document de rôle
        let roleDoc = get(/databases/$(database)/documents/ecoles/$(schoolId)/admin_roles/$(profile.adminRole)).data;
        return roleDoc.permissions[permission] == true;
    }

    // =================================================================
    // Règles pour les collections racines
    // =================================================================

    // Collection des sessions parents temporaires
    match /sessions_parents/{sessionId} {
      allow read, create: if true; // Géré par les Cloud Functions
      allow update, delete: if false;
    }

    // Collection des utilisateurs (pour lier un UID à un schoolId)
    match /utilisateurs/{userId} {
      allow read, update, create: if isAuth() && request.auth.uid == userId;
      allow delete: if false; // Ne jamais supprimer ce lien
    }
    
    // Collection pour les demandes de contact
    match /contact_requests/{requestId} {
      allow create: if true;
      allow read, list, delete: if get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Collection des réponses à l'enquête
    match /survey_responses/{responseId} {
      allow create: if true; // Tout le monde peut soumettre l'enquête
      allow read, list: if get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid)).data.isAdmin == true; // Seuls les admins peuvent lire
      allow delete: if false;
    }
    
    // Collections système (pour les super-admins)
    match /system_logs/{logId} {
        allow read, create: if get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid)).data.isAdmin == true;
    }
     match /system_settings/{settingId} {
        allow read: if isAuth();
        allow write: if get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid)).data.isAdmin == true;
    }


    // =================================================================
    // Règles pour la collection `ecoles` et ses sous-collections
    // =================================================================

    match /ecoles/{schoolId} {
      // N'importe qui d'authentifié peut créer une école (processus d'onboarding)
      allow create: if isAuth();
      
      // Seuls les membres de l'école peuvent lire les informations de base de l'école
      allow read: if isSchoolMember(schoolId);
      
      // Seul le directeur ou un admin avec la permission peut mettre à jour l'école
      allow update: if isDirector(schoolId) || hasPermission(schoolId, 'manageSettings');
      
      // La suppression physique est désactivée (on utilise un soft delete via le statut)
      allow delete: if false;

      // --- SOUS-COLLECTIONS ---
      
      // Personnel de l'école
      match /personnel/{staffId} {
        allow read: if isSchoolStaff(schoolId);
        allow create: if isAuth() && request.auth.uid == staffId;
        allow update: if (isAuth() && request.auth.uid == staffId) || hasPermission(schoolId, 'manageUsers');
        allow delete: if hasPermission(schoolId, 'manageUsers');
      }
      
      // Parents de l'école (comptes Firebase Auth complets)
      match /parents/{parentId} {
        allow read: if (isAuth() && request.auth.uid == parentId) || hasPermission(schoolId, 'viewUsers');
        allow write: if hasPermission(schoolId, 'manageUsers');
      }

      // Rôles administratifs
      match /admin_roles/{roleId} {
        allow read: if isSchoolStaff(schoolId);
        allow write: if hasPermission(schoolId, 'manageSettings');
      }
      
      // Élèves
      match /eleves/{studentId} {
        allow read: if isSchoolStaff(schoolId) || isParentOfStudent(resource) || isParent(schoolId, studentId);
        allow write: if hasPermission(schoolId, 'manageUsers');
        
        // Sous-collections de l'élève (notes, paiements, etc.)
        match /{subcollection}/{docId} {
             allow read, write: if isSchoolStaff(schoolId) || isParentOfStudent(get(/databases/$(database)/documents/ecoles/$(schoolId)/eleves/$(studentId))) || isParent(schoolId, studentId);
        }
      }
      
      // Structure scolaire (cycles, niveaux, classes)
      match /cycles/{cycleId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageClasses');
      }
      match /niveaux/{niveauId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageClasses');
      }
       match /classes/{classeId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageClasses');
      }

      // Emploi du temps
      match /emploi_du_temps/{entryId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageSchedule');
      }
      
      // Absences
      match /absences/{absenceId} {
        allow read: if isSchoolStaff(schoolId) || isParent(schoolId, resource.data.studentId);
        allow write: if hasPermission(schoolId, 'manageAttendance');
      }

      // Communication
      match /messagerie/{messageId} {
        allow get, update: if isSchoolMember(schoolId);
        // Permet de lister les messages destinés à tous.
        allow list: if isSchoolMember(schoolId) && (request.query.limit <= 20 || (request.query.where[0][0] == 'recipients.all' && request.query.where[0][2] == true));
        allow create: if hasPermission(schoolId, 'manageCommunication');
      }
      
      // Finances (frais, comptabilité)
      match /frais_scolarite/{feeId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageBilling');
      }
      match /comptabilite/{transactionId} {
        allow read: if hasPermission(schoolId, 'manageBilling');
        allow write: if hasPermission(schoolId, 'manageBilling');
      }

      // Bibliothèque
       match /bibliotheque/{bookId} {
        allow read: if isSchoolMember(schoolId);
        allow write: if hasPermission(schoolId, 'manageLibrary');
      }

      // Modules complémentaires (cantine, transport, etc.)
       match /cantine_menus/{menuId} {
        allow read: if isSchoolMember(schoolId) || isParent(schoolId, null);
        allow write: if hasPermission(schoolId, 'manageCantine');
      }
       match /cantine_reservations/{reservationId} {
        allow read: if isSchoolStaff(schoolId) || (isParent(schoolId, resource.data.studentId));
        allow write: if hasPermission(schoolId, 'manageCantine') || (isParent(schoolId, request.resource.data.studentId));
      }
       match /cantine_abonnements/{subscriptionId} {
        allow read: if isSchoolStaff(schoolId) || (isParent(schoolId, resource.data.studentId));
        allow write: if hasPermission(schoolId, 'manageCantine');
      }
       match /transport_bus/{busId} {
        allow read: if isSchoolMember(schoolId) || isParent(schoolId, null);
        allow write: if hasPermission(schoolId, 'manageTransport');
      }
       match /transport_lignes/{routeId} {
        allow read: if isSchoolMember(schoolId) || isParent(schoolId, null);
        allow write: if hasPermission(schoolId, 'manageTransport');
      }
       match /transport_abonnements/{subscriptionId} {
        allow read: if isSchoolStaff(schoolId) || (isParent(schoolId, resource.data.studentId));
        allow write: if hasPermission(schoolId, 'manageTransport');
      }
       match /internat_batiments/{buildingId} {
        allow read: if isSchoolStaff(schoolId);
        allow write: if hasPermission(schoolId, 'manageInternat');
      }
       match /internat_chambres/{roomId} {
        allow read: if isSchoolStaff(schoolId);
        allow write: if hasPermission(schoolId, 'manageInternat');
      }
       match /internat_occupants/{occupationId} {
        allow read: if isSchoolStaff(schoolId) || (isParent(schoolId, resource.data.studentId));
        allow write: if hasPermission(schoolId, 'manageInternat');
      }
       match /internat_entrees_sorties/{logId} {
        allow read: if isSchoolStaff(schoolId) || (isParent(schoolId, resource.data.studentId));
        allow write: if hasPermission(schoolId, 'manageInternat');
      }
      match /inventaire/{materielId} {
        allow read: if isSchoolStaff(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }
      match /salles/{salleId} {
        allow read: if isSchoolStaff(schoolId);
        allow write: if hasPermission(schoolId, 'manageRooms');
      }
      match /reservations_salles/{reservationId} {
        allow read: if isSchoolStaff(schoolId);
        allow write: if hasPermission(schoolId, 'manageRooms');
      }
       match /maintenance/{tacheId} {
        allow read: if isSchoolStaff(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }
      match /cles_trousseaux/{trousseauId} {
        allow read: if isSchoolStaff(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }
      match /cles_log/{logId} {
        allow read: if isSchoolStaff(schoolId);
        allow write: if hasPermission(schoolId, 'manageInventory');
      }
       match /activites/{activiteId} {
        allow read: if isSchoolMember(schoolId) || isParent(schoolId, null);
        allow write: if hasPermission(schoolId, 'manageActivities');
      }
       match /inscriptions_activites/{inscriptionId} {
        allow read: if isSchoolStaff(schoolId) || (isParent(schoolId, resource.data.studentId));
        allow write: if hasPermission(schoolId, 'manageActivities');
      }
       match /competitions/{competitionId} {
        allow read: if isSchoolMember(schoolId) || isParent(schoolId, null);
        allow write: if hasPermission(schoolId, 'manageActivities');
      }
       match /participations_competitions/{participationId} {
        allow read: if isSchoolStaff(schoolId) || (isParent(schoolId, resource.data.studentId));
        allow write: if hasPermission(schoolId, 'manageActivities');
      }
    }
  }
}

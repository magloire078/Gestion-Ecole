rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isUserAuthenticated() {
      return request.auth != null;
    }

    // Reads the user's schoolId from the root /users/{uid} document.
    function getUserSchoolId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.schoolId;
    }

    // Checks if the user making the request belongs to the school they are trying to access.
    function isUserInSchool(schoolId) {
      return isUserAuthenticated() && getUserSchoolId() == schoolId;
    }
    
    // --- Root Collections ---

    // The `users` collection maps a user's UID to their school ID.
    // This is the cornerstone of the new security model.
    match /users/{userId} {
      // Allow a user to create their own mapping document during onboarding.
      allow create: if isUserAuthenticated() && request.auth.uid == userId;

      // Allow a user to read their own mapping document.
      allow get: if isUserAuthenticated() && request.auth.uid == userId;
      
      // Deny any updates or deletions by clients to prevent users from changing their school.
      allow update, delete, list: if false;
    }

    // --- School-Specific Data ---
    match /schools/{schoolId} {
      
      // Allow an authenticated user to create a school document IF their UID matches the directorId in the new document.
      allow create: if isUserAuthenticated() && request.resource.data.directorId == request.auth.uid;
      
      // Once created, only users belonging to that school can read the main school document.
      allow get: if isUserInSchool(schoolId);
      
      // Deny listing, updating, or deleting the school document itself by clients.
      allow list, update, delete: if false;

      // --- Subcollections within a School ---

      // Rule for the users subcollection.
      match /users/{userId} {
         // Allow users to create their own user profile during onboarding (as part of the batch).
         allow create: if isUserAuthenticated() && request.auth.uid == userId;
         
         // Allow users to read/update their own profile if they are in the school.
         allow read, update: if isUserInSchool(schoolId) && request.auth.uid == userId;
         
         // Deny deleting user profiles via client.
         allow delete: if false;
      }
      
      // Generic rules for all other subcollections (teachers, classes, students, etc.).
      match /{otherCollections}/{docId} {
         // Allow full read/write/delete access for any user who belongs to the school.
         // Creation of documents in these collections is handled by specific app logic (e.g., student registration page).
         allow read, write, delete: if isUserInSchool(schoolId);
         allow create: if isUserInSchool(schoolId);
      }
    }
  }
}

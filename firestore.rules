
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isUserAuthenticated() {
      return request.auth != null;
    }
    
    function isUserAdmin() {
      return request.auth.token.admin == true;
    }

    function getUserSchoolId(userId) {
      let userDoc = get(/databases/$(database)/documents/utilisateurs/$(userId));
      return userDoc.exists ? userDoc.data.schoolId : null;
    }
    
    function isUserInSchool(schoolId) {
      return isUserAuthenticated() && getUserSchoolId(request.auth.uid) == schoolId;
    }
    
    function getUserRole(userId) {
      let staffDoc = get(/databases/$(database)/documents/personnel/$(userId));
      return staffDoc.exists ? staffDoc.data.role : null;
    }
    
    function isSchoolDirector(schoolId) {
      let schoolDoc = get(/databases/$(database)/documents/ecoles/$(schoolId));
      return schoolDoc.exists && schoolDoc.data.directorId == request.auth.uid;
    }

    function isCreatingOwnDocument(userId) {
      return request.auth.uid == userId;
    }
    
    function isStaffMember(schoolId) {
      let staffDoc = get(/databases/$(database)/documents/personnel/$(request.auth.uid));
      return staffDoc.exists && staffDoc.data.schoolId == schoolId;
    }
    
    function isTeacher(schoolId) {
      let role = getUserRole(request.auth.uid);
      return role != null && (role == 'enseignant' || role == 'directeur') 
             && isStaffMember(schoolId);
    }
    
    // --- Validation Functions ---
    function isValidSchoolId(schoolId) {
      return schoolId is string && schoolId.size() <= 100;
    }
    
    function isNotChangingRole() {
      return request.resource.data.role == resource.data.role;
    }
    
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // --- Root Collections ---

    // Collection: utilisateurs
    match /utilisateurs/{userId} {
      allow create: if 
        isUserAuthenticated() && 
        isCreatingOwnDocument(userId) && 
        !exists(/databases/$(database)/documents/utilisateurs/$(userId));
      
      allow get: if 
        isUserAuthenticated() && 
        (isCreatingOwnDocument(userId) || isUserAdmin());
      
      allow list: if false;
      
      allow update: if 
        isUserAdmin();
      
      allow delete: if isUserAdmin();
    }
    
    // Collection: ecoles
    match /ecoles/{schoolId} {
      allow create: if 
        isUserAuthenticated() && 
        request.resource.data.directorId == request.auth.uid;
      
      allow get: if 
        isUserAuthenticated() && 
        (isUserInSchool(schoolId) || isUserAdmin());
      
      allow list: if isUserAdmin();
      
      allow update: if 
        (isSchoolDirector(schoolId) || isUserAdmin()) &&
        !request.resource.data.keys().hasAny(['directorId']);
      
      allow delete: if isUserAdmin();
    }

    // Collection: personnel
    match /personnel/{staffId} {
      function getStaffSchoolId() {
        let doc = get(/databases/$(database)/documents/personnel/$(staffId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        isUserInSchool(getStaffSchoolId());
      
      allow list: if 
        isUserAuthenticated() && 
        request.query.schoolId != null &&
        isUserInSchool(request.query.schoolId);
        
      allow create: if 
        isUserAuthenticated() && 
        (
          (isSchoolDirector(request.resource.data.schoolId) &&
           request.resource.data.schoolId == getUserSchoolId(request.auth.uid)) ||
          isUserAdmin() ||
          (isCreatingOwnDocument(staffId) && 
           request.resource.data.role == 'directeur')
        );
      
      allow update: if 
        isUserAuthenticated() && 
        (
          (isSchoolDirector(getStaffSchoolId()) &&
           request.resource.data.schoolId == getStaffSchoolId()) ||
          isUserAdmin() ||
          (isCreatingOwnDocument(staffId) && 
           isNotChangingRole() &&
           !request.resource.data.keys().hasAny(['schoolId']))
        );
      
      allow delete: if 
        isUserAuthenticated() && 
        (isSchoolDirector(getStaffSchoolId()) || isUserAdmin());
    }

    // Collection: eleves
    match /eleves/{studentId} {
      function getStudentSchoolId() {
        let doc = get(/databases/$(database)/documents/eleves/$(studentId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        isUserInSchool(getStudentSchoolId());
      
      allow list: if 
        isUserAuthenticated() && 
        request.query.schoolId != null &&
        isUserInSchool(request.query.schoolId);
      
      allow create: if 
        isUserAuthenticated() && 
        isStaffMember(request.resource.data.schoolId) &&
        request.resource.data.schoolId == getUserSchoolId(request.auth.uid);
      
      allow update: if 
        isUserAuthenticated() && 
        isStaffMember(getStudentSchoolId()) &&
        request.resource.data.schoolId == getStudentSchoolId();
      
      allow delete: if 
        isUserAuthenticated() && 
        (isSchoolDirector(getStudentSchoolId()) || isUserAdmin());
      
      // Sous-collection: notes
      match /notes/{gradeId} {
        allow read: if 
          isUserAuthenticated() && 
          (isTeacher(getStudentSchoolId()) || isUserAdmin());
        
        allow write: if 
          isUserAuthenticated() && 
          isTeacher(getStudentSchoolId());
      }
      
      // Sous-collection: paiements
      match /paiements/{paymentId} {
        allow read, list: if 
          isUserAuthenticated() && 
          isStaffMember(getStudentSchoolId());
        
        allow create: if 
          isUserAuthenticated() && 
          isStaffMember(getStudentSchoolId());
        
        allow update, delete: if 
          isUserAuthenticated() && 
          (isSchoolDirector(getStudentSchoolId()) || isUserAdmin());
      }
    }

    // Collection: absences
    match /absences/{absenceId} {
      function getAbsenceSchoolId() {
        let doc = get(/databases/$(database)/documents/absences/$(absenceId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        isStaffMember(getAbsenceSchoolId());
      
      allow list: if 
        isUserAuthenticated() && 
        request.query.schoolId != null &&
        isStaffMember(request.query.schoolId);
      
      allow create: if 
        isUserAuthenticated() && 
        isTeacher(request.resource.data.schoolId);
      
      allow update: if 
        isUserAuthenticated() && 
        isStaffMember(getAbsenceSchoolId()) &&
        request.resource.data.schoolId == getAbsenceSchoolId();
    }
    
    // Collection: comptabilite
    match /comptabilite/{transactionId} {
      function getTransactionSchoolId() {
        let doc = get(/databases/$(database)/documents/comptabilite/$(transactionId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        (getUserRole(request.auth.uid) in ['directeur', 'comptable', 'admin'] &&
         isStaffMember(getTransactionSchoolId()));
         
      allow list: if 
        isUserAuthenticated() && 
        request.query.schoolId != null &&
        (getUserRole(request.auth.uid) in ['directeur', 'comptable', 'admin'] &&
         isStaffMember(request.query.schoolId));
      
      allow create: if 
        isUserAuthenticated() && 
        (getUserRole(request.auth.uid) in ['directeur', 'comptable', 'admin']) &&
        isStaffMember(request.resource.data.schoolId);
      
      allow update, delete: if 
        isUserAuthenticated() && 
        (isSchoolDirector(getTransactionSchoolId()) || isUserAdmin());
    }

    // Collection: classes
    match /classes/{classId} {
      function getClassSchoolId() {
        let doc = get(/databases/$(database)/documents/classes/$(classId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        isUserInSchool(getClassSchoolId());
      
      allow list: if 
        isUserAuthenticated() && 
        request.query.schoolId != null &&
        isUserInSchool(request.query.schoolId);
      
      allow create: if 
        isUserAuthenticated() && 
        (isSchoolDirector(request.resource.data.schoolId) || isUserAdmin()) &&
        request.resource.data.schoolId == getUserSchoolId(request.auth.uid);
      
      allow update: if 
        isUserAuthenticated() && 
        isStaffMember(getClassSchoolId()) &&
        request.resource.data.schoolId == getClassSchoolId();
      
      allow delete: if 
        isUserAuthenticated() && 
        (isSchoolDirector(getClassSchoolId()) || isUserAdmin());
    }
    
    // Collection: emploi_du_temps
    match /emploi_du_temps/{entryId} {
      function getScheduleSchoolId() {
        let doc = get(/databases/$(database)/documents/emploi_du_temps/$(entryId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        isUserInSchool(getScheduleSchoolId());
      
      allow write: if 
        isUserAuthenticated() && 
        (isSchoolDirector(request.resource.data.schoolId) || isUserAdmin());
    }
    
    // Collection: messagerie
    match /messagerie/{messageId} {
      function getMessageSchoolId() {
        let doc = get(/databases/$(database)/documents/messagerie/$(messageId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        isUserInSchool(getMessageSchoolId());
      
      allow create: if 
        isUserAuthenticated() && 
        isStaffMember(request.resource.data.schoolId);
      
      allow update: if false;
      
      allow delete: if 
        isUserAuthenticated() && 
        (resource.data.senderId == request.auth.uid || isUserAdmin());
    }

    // Collection: bibliotheque
    match /bibliotheque/{bookId} {
      function getBookSchoolId() {
        let doc = get(/databases/$(database)/documents/bibliotheque/$(bookId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        isUserInSchool(getBookSchoolId());
      
      allow write: if 
        isUserAuthenticated() && 
        (getUserRole(request.auth.uid) in ['directeur', 'admin']) &&
        isStaffMember(request.resource.data.schoolId);
    }
    
    // Collection: frais_scolarite
    match /frais_scolarite/{feeId} {
      function getFeeSchoolId() {
        let doc = get(/databases/$(database)/documents/frais_scolarite/$(feeId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        isStaffMember(getFeeSchoolId());
      
      allow write: if 
        isUserAuthenticated() && 
        (getUserRole(request.auth.uid) in ['directeur', 'admin']) &&
        isStaffMember(request.resource.data.schoolId);
    }
    
    // Collection: cycles
    match /cycles/{cycleId} {
      function getCycleSchoolId() {
        let doc = get(/databases/$(database)/documents/cycles/$(cycleId));
        return doc.exists ? doc.data.schoolId : null;
      }
      
      allow read: if 
        isUserAuthenticated() && 
        isUserInSchool(getCycleSchoolId());
      
      allow write: if 
        isUserAuthenticated() && 
        (isSchoolDirector(request.resource.data.schoolId) || isUserAdmin());
    }
    
    // Collection: admin_roles
    match /admin_roles/{roleId} {
      allow read, write: if 
        isUserAuthenticated() && 
        request.auth.token.admin == true;
    }
    
    // --- Global Rules ---
    // Deny all other collections/paths not explicitly defined above
    match /{document=**} {
      allow read, write: if false;
    }
  }
}


rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isUserAuthenticated() {
      return request.auth != null;
    }

    // Reads the user's schoolId from the root /users/{uid} document.
    function getUserSchoolId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.schoolId;
    }

    // Checks if the user making the request belongs to the school they are trying to access.
    function isUserInSchool(schoolId) {
      return isUserAuthenticated() && getUserSchoolId() == schoolId;
    }
    
    // --- Root Collections ---

    // The `users` collection maps a user's UID to their school ID.
    // This is the cornerstone of the security model.
    match /users/{userId} {
      // Allow an authenticated user to create their own mapping, if it doesn't exist yet.
      // This is for joining a school.
      allow create: if isUserAuthenticated() && request.auth.uid == userId && !exists(/databases/$(database)/documents/users/$(userId));
      
      // Allow a user to read their own mapping document.
      allow get: if isUserAuthenticated() && request.auth.uid == userId;
      
      // Deny any updates or deletions by clients to prevent users from changing their school.
      allow update, delete, list: if false;
    }
    
    // Anyone can read the schools collection to find a school by its code
    match /schools/{schoolId} {
        // Anyone authenticated can create a school document
        allow create: if isUserAuthenticated();
        
        // Any user belonging to the school can read or update it (e.g. from settings page).
        allow get, update: if isUserInSchool(schoolId);
        
        // Anyone can query the list of schools to find one by code.
        allow list: if isUserAuthenticated();
        
        // Deny deleting school documents.
        allow delete: if false;

        // --- Subcollections within a School ---

        // Rule for the users subcollection.
        match /users/{userId} {
            // Allow an authenticated user to create their own user profile document in the school,
            // as long as their root user mapping document exists and points to this school.
            // This is for the "join school" flow.
            allow create: if isUserInSchool(schoolId) && request.auth.uid == userId;
            
            // Allow users to read/update their own profile if they are in the school.
            allow read, update: if isUserInSchool(schoolId) && request.auth.uid == userId;
            
            // Deny deleting user profiles via client.
            allow delete: if false;
            
            // Allow a director to list all user profiles in their school.
            allow list: if isUserInSchool(schoolId);
        }
        
        // Generic rules for all other subcollections (teachers, classes, students, etc.).
        match /{otherCollections}/{docId} {
            // Allow full read/write access for any user who belongs to the school.
            allow read, write: if isUserInSchool(schoolId);
        }
    }
  }
}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== UTILITY FUNCTIONS ==========
    function isAuth() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isAuth() && request.auth.token.superAdmin == true;
    }
    
    function isSchoolMember(schoolId) {
        // Vérifier via claims OU via directeur dans BD
        return isAuth() && (
          request.auth.token.schoolId == schoolId ||
          get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == request.auth.uid
        );
    }
    
    function isUser(userId) {
        return isAuth() && request.auth.uid == userId;
    }
    
    function isDirector(schoolId) {
        // Vérifier via BD directement
        let schoolData = get(/databases/$(database)/documents/ecoles/$(schoolId)).data;
        return isAuth() && request.auth.uid == schoolData.directorId;
    }
    
    // Fonction simplifiée pour création d'école
    function canCreateSchool() {
        return isAuth() && request.resource.data.directorId == request.auth.uid;
    }

    // ========== GLOBAL RULES ==========

    // Les Super Admins ont un accès total.
    match /{path=**} {
      allow read, write: if isSuperAdmin();
    }

    // ========== SCHOOL-CREATION RULES ==========

    // Règle cruciale : création d'école
    match /ecoles/{schoolId} {
      // Création : vérifier que l'utilisateur se désigne comme directeur
      allow create: if canCreateSchool();
      
      // Lecture : authentifié + (membre OU directeur selon BD)
      allow read: if isAuth() && (
        isSchoolMember(schoolId) ||
        get(/databases/$(database)/documents/ecoles/$(schoolId)).data.directorId == request.auth.uid
      );
      
      // Mise à jour : seulement le directeur
      allow update: if isDirector(schoolId);
      
      // Pas de suppression directe
      allow delete: if false;
    }

    // Règle pour la création du profil du directeur
    match /ecoles/{schoolId}/personnel/{staffId} {
        // SIMPLIFIÉ : permettre si l'utilisateur est le directeur qu'il crée
        allow create: if isAuth() && 
                      staffId == request.auth.uid && 
                      request.resource.data.role == 'directeur' &&
                      request.resource.data.uid == request.auth.uid;
        
        // Après création
        allow get, list: if isSchoolMember(schoolId);
        allow update: if isDirector(schoolId) || isUser(staffId);
        allow delete: if isDirector(schoolId);
    }
    
    // ========== USER-SPECIFIC RULES ==========
    
    // Document utilisateur
    match /utilisateurs/{userId} {
      allow read: if isUser(userId);
      // Permettre la création/mise à jour pendant l'onboarding
      allow write: if isAuth() && (
        isUser(userId) || // L'utilisateur lui-même
        // Pendant la création d'école, on met juste à jour schoolId
        (request.resource.data.keys().hasOnly(['schoolId']) && 
         resource == null) // S'il n'existe pas encore
      );
    }
    
    // ========== SYSTEM LOGS ==========
    
    match /system_logs/{logId} {
      allow create: if isAuth();
      allow read: if isAuth() && (isSuperAdmin() || request.auth.token.isDirector == true);
    }

    // ========== GENERIC SCHOOL DATA RULES ==========
    
    match /ecoles/{schoolId}/{collection}/{document=**} {
      allow read, write: if isSchoolMember(schoolId);
    }
  }
}